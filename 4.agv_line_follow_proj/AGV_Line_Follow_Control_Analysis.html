<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGV Line Following Control 시스템 분석</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        h1, h2, h3 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        h1 {
            font-size: 2.5em;
            text-align: center;
            color: #e74c3c;
        }
        h2 {
            font-size: 2em;
            margin-top: 30px;
        }
        h3 {
            font-size: 1.5em;
        }
        .emoji {
            font-size: 1.2em;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #3498db;
            color: white;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        pre {
            background-color: #f4f4f4;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            overflow-x: auto;
            font-family: 'Courier New', Courier, monospace;
        }
        code {
            background-color: #f4f4f4;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: 'Courier New', Courier, monospace;
        }
        .highlight {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px;
            margin: 15px 0;
        }
        .info-box {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        .warning-box {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        .success-box {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        .architecture {
            font-family: monospace;
            background-color: #f8f9fa;
            border: 2px solid #6c757d;
            padding: 20px;
            margin: 15px 0;
            white-space: pre-line;
        }
        @media print {
            body { font-size: 12px; }
            h1 { font-size: 18px; }
            h2 { font-size: 16px; }
            h3 { font-size: 14px; }
        }
    </style>
</head>
<body>
    <h1><span class="emoji">📚</span> AGV Line Following Control 시스템 분석</h1>
    
    <div class="info-box">
        <strong>문서 정보</strong><br>
        📅 생성일: 2025년 11월 3일<br>
        📁 분석 대상: agv_line_follow_control.py<br>
        🎯 프로젝트: AGV Line Follow Control System<br>
        👨‍🏫 용도: 대학생 교육 자료
    </div>

    <h2><span class="emoji">📦</span> 1. 라이브러리 및 모듈 임포트 소개</h2>
    
    <h3>1.1 표준 라이브러리</h3>
    <pre><code>import time     # 시간 관리 및 제어 주기 설정
import curses   # 터미널 기반 사용자 인터페이스 (TUI)</code></pre>
    
    <h3>1.2 커스텀 모듈</h3>
    <pre><code>from Donkibot_i import Comm  # AGV 통신 클래스 (자체 개발 모듈)</code></pre>
    
    <h3>각 모듈의 역할과 특징</h3>
    <table>
        <tr>
            <th>모듈</th>
            <th>주요 기능</th>
            <th>특징</th>
            <th>용도</th>
        </tr>
        <tr>
            <td><strong>time</strong></td>
            <td>time.time(), time.sleep(), time.strftime()</td>
            <td>정밀한 타이밍 제어</td>
            <td>50ms 제어 주기 관리</td>
        </tr>
        <tr>
            <td><strong>curses</strong></td>
            <td>stdscr.getch(), stdscr.addstr(), stdscr.nodelay()</td>
            <td>실시간 콘솔 UI</td>
            <td>키보드 제어 및 상태 표시</td>
        </tr>
        <tr>
            <td><strong>Donkibot_i</strong></td>
            <td>Comm 클래스, STSFrame 데이터클래스</td>
            <td>시리얼 통신 + 멀티스레딩</td>
            <td>AGV 센서 데이터 및 제어 명령</td>
        </tr>
    </table>

    <h2><span class="emoji">🎯</span> 2. SW 구현 목적</h2>
    
    <div class="highlight">
        <h3>LCU(Line Control Unit) 기반 라인 추종 AGV 제어 시스템</h3>
    </div>
    
    <p><strong>이 소프트웨어의 핵심 목적:</strong></p>
    <ul>
        <li><strong>자율 라인 추종</strong>: LCU 센서로 라인을 감지하여 자동으로 경로 추종</li>
        <li><strong>실시간 안전 시스템</strong>: 비상정지, 장애물 감지를 통한 안전 운행</li>
        <li><strong>사용자 제어 인터페이스</strong>: 키보드를 통한 직관적인 AGV 제어</li>
        <li><strong>교육용 플랫폼</strong>: 라인 추종 알고리즘의 이해와 실습</li>
    </ul>

    <h3>산업 응용 분야</h3>
    <ul>
        <li><span class="emoji">🏭</span> <strong>공장 자동화</strong>: 자재 운반 AGV 시스템</li>
        <li><span class="emoji">📦</span> <strong>물류 창고</strong>: 자동 피킹 및 배송 로봇</li>
        <li><span class="emoji">🏥</span> <strong>병원</strong>: 의료용품/약품 자동 운반 시스템</li>
        <li><span class="emoji">🎓</span> <strong>교육</strong>: 로봇공학 및 제어공학 실습 도구</li>
    </ul>

    <h2><span class="emoji">🔧</span> 3. 주요 함수 및 사용한 AGV 데이터 분석</h2>
    
    <h3>3.1 draw_menu(stdscr) - 메뉴 시스템</h3>
    <pre><code>def draw_menu(stdscr):
    """메인 메뉴를 화면에 그립니다."""
    global agv_running, agv_paused
    
    # 현재 상태 표시
    if agv_running and not agv_paused:
        status = "[ON] 라인 추종 활성화 중"
    elif agv_running and agv_paused:
        status = "[PAUSE] 일시정지 중" 
    else:
        status = "[OFF] 정지됨"</code></pre>

    <div class="success-box">
        <h4>특징:</h4>
        <ul>
            <li><span class="emoji">📊</span> <strong>실시간 상태 표시</strong>: AGV의 현재 동작 상태를 시각적으로 표시</li>
            <li><span class="emoji">🎮</span> <strong>직관적 메뉴</strong>: 모니터링과 제어 모드를 명확하게 분리</li>
            <li><span class="emoji">🔄</span> <strong>전역 상태 관리</strong>: agv_running, agv_paused 변수로 상태 추적</li>
        </ul>
    </div>

    <h3>3.2 핵심 센서 데이터 활용</h3>
    <table>
        <tr>
            <th>센서 데이터</th>
            <th>용도</th>
            <th>범위/조건</th>
            <th>제어 반응</th>
        </tr>
        <tr>
            <td><strong>LinePos</strong></td>
            <td>라인 위치 감지</td>
            <td>-15 ~ +15</td>
            <td>주 제어 알고리즘</td>
        </tr>
        <tr>
            <td><strong>EmgFlag</strong></td>
            <td>비상정지</td>
            <td>0/1</td>
            <td>즉시 정지</td>
        </tr>
        <tr>
            <td><strong>LidarDistance</strong></td>
            <td>장애물 감지</td>
            <td>< 150mm</td>
            <td>안전 정지</td>
        </tr>
        <tr>
            <td><strong>SOC</strong></td>
            <td>배터리 상태</td>
            <td>0-100%</td>
            <td>상태 모니터링</td>
        </tr>
        <tr>
            <td><strong>Speed</strong></td>
            <td>현재 속도</td>
            <td>mm/s</td>
            <td>피드백 제어</td>
        </tr>
        <tr>
            <td><strong>RF_tag1/2</strong></td>
            <td>위치 및 속도 제한</td>
            <td>임의값</td>
            <td>구간별 제어</td>
        </tr>
    </table>

    <h2><span class="emoji">🧠</span> 4. 제어 알고리즘 설명</h2>

    <h3>4.1 안전 우선 순위 시스템</h3>
    <pre><code># 1순위: 비상정지
if s.EmgFlag == 1:
    vl, vr = 0, 0
    status_msg = "🚨 비상정지 활성화"

# 2순위: 장애물 감지
elif s.LidarDistance < OBSTACLE_E_STOP_DISTANCE:
    vl, vr = 0, 0
    status_msg = "🚧 장애물 감지 - 정지"</code></pre>

    <h3>4.2 라인 추종 제어 알고리즘 <span class="emoji">🎯</span></h3>
    
    <div class="highlight">
        <strong>핵심 아이디어:</strong> LinePos 값에 따른 차동 구동 제어
    </div>

    <pre><code>line_pos = s.LinePos  # -15(왼쪽) ~ 0(중앙) ~ +15(오른쪽)

if abs(line_pos) > 8:
    # ±8 초과: 제자리 회전 (Pivot Turn)
    if line_pos < -8:
        vl = -TURN_SPEED_DIFF  # 좌바퀴 후진
        vr = TURN_SPEED_DIFF   # 우바퀴 전진
        # → 제자리 좌회전
    else:
        vl = TURN_SPEED_DIFF   # 좌바퀴 전진
        vr = -TURN_SPEED_DIFF  # 우바퀴 후진
        # → 제자리 우회전

elif line_pos == 0:
    # 중앙: 직진
    vl = BASE_SPEED
    vr = BASE_SPEED

else:
    # ±8 이하: 부드러운 회전 (Differential Steering)
    turn_intensity = abs(line_pos) / 8.0  # 0~1 정규화
    speed_reduction = int(TURN_SPEED_DIFF * turn_intensity)
    
    if line_pos < 0:  # 라인이 왼쪽에 위치
        vl = BASE_SPEED - speed_reduction  # 좌바퀴 감속
        vr = BASE_SPEED                    # 우바퀴 정속
        # → 부드러운 좌회전
    else:  # 라인이 오른쪽에 위치
        vl = BASE_SPEED                    # 좌바퀴 정속
        vr = BASE_SPEED - speed_reduction  # 우바퀴 감속
        # → 부드러운 우회전</code></pre>

    <h3>4.3 제어 알고리즘 시각화</h3>
    <div class="architecture">
LinePos 값에 따른 제어 전략:

┌─────────────────────────────────────────────────────────┐
│  -15    -8    -4    0    +4    +8    +15               │
│   │      │     │     │     │     │      │               │
│   └──────┼─────┼─────┼─────┼─────┼──────┘               │
│         제자리  부드러운   직진  부드러운   제자리         │
│         좌회전   좌회전          우회전    우회전         │
└─────────────────────────────────────────────────────────┘

제어 방식:
1. |LinePos| > 8: 제자리 회전 (Pivot Turn)
2. |LinePos| ≤ 8: 차등 속도 제어 (Differential Steering)
3. LinePos = 0: 직진 주행
    </div>

    <h3>4.4 수학적 모델링</h3>
    
    <h4>부드러운 회전 공식:</h4>
    <pre><code>turn_intensity = |LinePos| / 8.0  (0 ≤ turn_intensity ≤ 1)
speed_reduction = TURN_SPEED_DIFF × turn_intensity

if LinePos < 0:  // 왼쪽 편향
    vl = BASE_SPEED - speed_reduction
    vr = BASE_SPEED
else:  // 오른쪽 편향
    vl = BASE_SPEED
    vr = BASE_SPEED - speed_reduction</code></pre>

    <h4>제자리 회전 공식:</h4>
    <pre><code>if LinePos < -8:  // 심한 왼쪽 편향
    vl = -TURN_SPEED_DIFF
    vr = +TURN_SPEED_DIFF
else:  // 심한 오른쪽 편향
    vl = +TURN_SPEED_DIFF
    vr = -TURN_SPEED_DIFF</code></pre>

    <h2><span class="emoji">📋</span> 5. 분석 요약 설명</h2>

    <h3>5.1 시스템 아키텍처</h3>
    <div class="architecture">
AGV Line Following Control System
│
├── 🎮 사용자 인터페이스 계층
│   ├── 메뉴 시스템 (상태 표시)
│   ├── 실시간 데이터 모니터링
│   ├── 키보드 제어 인터페이스
│   └── 시각적 피드백 (라인 위치 표시)
│
├── 🧠 제어 알고리즘 계층
│   ├── 안전 우선순위 시스템
│   ├── 라인 추종 알고리즘
│   ├── 차동 구동 제어
│   └── 실시간 제어 루프 (50ms)
│
├── 📊 센서 데이터 처리 계층
│   ├── LinePos 기반 주 제어
│   ├── LiDAR 장애물 감지
│   ├── 비상정지 시스템
│   └── 배터리 및 속도 모니터링
│
└── 📡 하드웨어 통신 계층
    ├── 시리얼 통신 (Donkibot_i)
    ├── 실시간 데이터 수신
    ├── 제어 명령 전송 (CLR)
    └── 멀티스레딩 처리
    </div>

    <h3>5.2 핵심 기술 요소</h3>
    
    <div class="info-box">
        <h4><span class="emoji">🎓</span> 제어공학 개념</h4>
        <ol>
            <li><strong>PD 제어와 유사</strong>: 위치 오차(LinePos)에 비례한 제어 출력</li>
            <li><strong>차동 구동 제어</strong>: 두 바퀴의 속도 차이로 방향 제어</li>
            <li><strong>실시간 제어</strong>: 50ms 주기의 정밀한 타이밍 제어</li>
            <li><strong>상태 기반 제어</strong>: 다양한 조건에 따른 제어 모드 전환</li>
        </ol>
    </div>

    <div class="success-box">
        <h4><span class="emoji">🤖</span> 로봇공학 개념</h4>
        <ol>
            <li><strong>센서 융합</strong>: 다중 센서(LinePos, LiDAR, EMG) 통합 활용</li>
            <li><strong>안전 시스템</strong>: 계층적 안전 우선순위 구조</li>
            <li><strong>사용자 인터페이스</strong>: 실시간 모니터링 및 제어</li>
            <li><strong>하드웨어 추상화</strong>: 시리얼 통신을 통한 하드웨어 제어</li>
        </ol>
    </div>

    <h3>5.3 교육적 가치</h3>

    <h4>학습 목표:</h4>
    <ul>
        <li>✅ <strong>라인 추종 알고리즘</strong>: 기본적인 자율주행 개념 이해</li>
        <li>✅ <strong>차동 구동 제어</strong>: 로봇 이동 메커니즘 학습</li>
        <li>✅ <strong>실시간 제어</strong>: 제어 주기와 안정성의 중요성</li>
        <li>✅ <strong>안전 시스템</strong>: 로봇 시스템의 안전 설계 원칙</li>
    </ul>

    <h4>실무 연결성:</h4>
    <ul>
        <li><span class="emoji">🚗</span> <strong>자율주행차</strong>: 차선 유지 보조 시스템 (LKA)</li>
        <li><span class="emoji">🏭</span> <strong>산업용 AGV</strong>: 공장 자동화 라인</li>
        <li><span class="emoji">📦</span> <strong>물류 로봇</strong>: 창고 자동화 시스템</li>
        <li><span class="emoji">🎓</span> <strong>교육용 로봇</strong>: STEM 교육 플랫폼</li>
    </ul>

    <h3>5.4 성능 지표</h3>
    
    <table>
        <tr>
            <th>성능 항목</th>
            <th>지표</th>
            <th>설명</th>
        </tr>
        <tr>
            <td><span class="emoji">⏱️</span> 응답 시간</td>
            <td>50ms 제어 주기</td>
            <td>빠른 반응성 확보</td>
        </tr>
        <tr>
            <td><span class="emoji">🎯</span> 정확도</td>
            <td>±8 범위 내 부드러운 제어</td>
            <td>정밀한 라인 추종</td>
        </tr>
        <tr>
            <td><span class="emoji">🛡️</span> 안전성</td>
            <td>다층 안전 시스템</td>
            <td>비상정지, 장애물 감지</td>
        </tr>
        <tr>
            <td><span class="emoji">📊</span> 가시성</td>
            <td>실시간 상태 모니터링</td>
            <td>직관적인 UI 제공</td>
        </tr>
    </table>

    <div class="highlight">
        <h2>결론</h2>
        <p>이 프로그램은 <strong>실제 산업용 AGV의 라인 추종 시스템</strong>을 충실히 구현한 것으로, 자율주행 로봇의 핵심 기술인 <strong>경로 추종, 센서 융합, 실시간 제어</strong>를 종합적으로 학습할 수 있는 excellent한 교육 자료입니다! <span class="emoji">🚗🤖🎯✨</span></p>
    </div>

    <footer style="margin-top: 50px; padding-top: 20px; border-top: 2px solid #3498db; text-align: center; color: #7f8c8d;">
        <p><strong>문서 생성일</strong>: 2025년 11월 3일 | <strong>분석 대상</strong>: agv_line_follow_control.py | <strong>프로젝트</strong>: AGV Line Follow Control System</p>
    </footer>
</body>
</html>