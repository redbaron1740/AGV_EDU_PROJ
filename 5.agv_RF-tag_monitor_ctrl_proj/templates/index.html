<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AGV Monitoring Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
        }
        .content {
            width: 1600px;
            margin: auto;
            padding: 10px;
        }
        .header-panel {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            padding: 8px 32px;
            margin-bottom: 18px;
        }
        .header-title {
            font-size: 28px;
            font-weight: bold;
            color: #111;
        }
        .header-center {
            display: flex;
            align-items: center;
            gap: 18px;
        }
        .go-btn {
            background: #43a047;
            color: #fff;
            font-size: 20px;
            font-weight: bold;
            border: none;
            border-radius: 6px;
            padding: 8px 32px;
            cursor: pointer;
        }
        .pause-btn {
            background: #ffa726;
            color: #fff;
            font-size: 20px;
            font-weight: bold;
            border: none;
            border-radius: 6px;
            padding: 8px 32px;
            cursor: pointer;
        }
        .stop-btn {
            background: #fff ;
            color: #d32f2f ;
            font-size: 18px;
            font-weight: bold;
            border: 3px solid #d32f2f;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }
        .stop-btn span {
            font-family: Arial, sans-serif;
            font-size: 16px;
            font-weight: bold;
            color: #d32f2f;
        }
        #canvas { background: url('/static/background.jpg') no-repeat center center; background-size: 1600px 763px; border: 1px solid #888; display: block; margin: 0 auto; } /* [ì‚­ì œ ìš©ì´] ìº”ë²„ìŠ¤ ë°°ê²½ ì´ë¯¸ì§€ í¬ê¸° ì¡°ì • */
        .label { font: bold 14px Arial; fill: #1976d2; }
        .map-container {
            position: relative;
            width: 1600px;
            height: 763;
            margin: 0 auto;
        }
        .agv-image {
            position: absolute;
            width: 50px;
            height: 75px;
            pointer-events: none;
        }
        /* ìƒíƒœ íŒ¨ë„ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .status-panel {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            padding: 18px 32px;
            margin-bottom: 18px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 18px;
        }
        .status-item {
            font-size: 18px;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="content">
        <!-- ìƒë‹¨ íŒ¨ë„ -->
        <div class="header-panel">
            <div class="header-title">AGV Monitoring Dashboard</div>
            <div class="header-center">
                <button class="go-btn" id="goBtn">GO</button>
                <select class="tag-select" id="waypointSelect" style="display:none;">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                </select>
                <button class="pause-btn" id="pauseBtn">Pause</button>
            </div>
            <button class="stop-btn" id="stopBtn"><span>STOP</span></button>
        </div>
        <!-- ì§€ë„ ë° AGV ì´ë¯¸ì§€ ìº”ë²„ìŠ¤ -->
        <div class="map-container">
            <canvas id="canvas" width="1600" height="763" style="position:absolute;left:0;top:0;"></canvas>
            <!-- ìƒíƒœ íŒ¨ë„: ì¤‘ì•™ ìƒë‹¨ì— ë„ì›€ (5ë²ˆ í”„ë¡œì íŠ¸ì™€ ë™ì¼) -->
            <div class="status-panel" id="status-panel" style="position: absolute; top: 75px; left: 50%; transform: translate(-50%, -50%); background-color: rgba(255,255,255,0.95); border-radius: 12px; padding: 20px 30px; box-shadow: 0 4px 8px rgba(0,0,0,0.3); min-width: 450px;">
                <div class="status-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px 30px;">
                    <div class="status-item" style="display: flex; align-items: center; font-size: 16px;"><strong>AGV ìƒíƒœ:&nbsp;&nbsp;</strong> <span id="agv-status">-</span></div>
                    <div class="status-item" style="display: flex; align-items: center; font-size: 16px;"><strong>ì œí•œ ì†ë„:&nbsp;&nbsp;</strong> <span id="speed-limit">- mm/s</span></div>
                    <div class="status-item" style="display: flex; align-items: center; font-size: 16px;"><strong>í˜„ì¬ íƒœê·¸:&nbsp;&nbsp;</strong> <span id="current-tag">-</span></div>
                    <div class="status-item" style="display: flex; align-items: center; font-size: 16px;"><strong>ì¥ ì•  ë¬¼:&nbsp;&nbsp;</strong> <span id="lidar-distance">- mm</span></div>
                    <div class="status-item" style="display: flex; align-items: center; font-size: 16px;"><strong>ëª©í‘œ íƒœê·¸:&nbsp;&nbsp;</strong> <span id="target-tag">-</span></div>
                    <div class="status-item" style="display: flex; align-items: center; font-size: 16px;"><strong>í˜„ì¬ ì†ë„:&nbsp;&nbsp;</strong> <span id="current-speed">- mm/s</span></div>
                </div>
            </div>
        </div>
    </div>
    <script>

        let agv_rf_tag = 0;

        // AGV ìƒíƒœ íŒ¨ë„ì„ /agv_dataì—ì„œ ì£¼ê¸°ì ìœ¼ë¡œ ê°±ì‹ 
        async function updateStatusPanel() {
            try {
                const res = await fetch('/agv_data');
                const data = await res.json();
                document.getElementById('agv-status').textContent = data.state || '-';
                document.getElementById('speed-limit').textContent = (data.speed_limit !== undefined ? Math.round(data.speed_limit) : '-') + ' mm/s';
                let temp = data.rf_tag -1 >= 0 ? data.rf_tag -1 : '-';
                document.getElementById('current-tag').textContent = temp || '-';
                document.getElementById('lidar-distance').textContent = (data.lidar_distance !== undefined ? Math.round(data.lidar_distance) : '-') + ' mm';
                document.getElementById('target-tag').textContent = data.rf_tag || '-';
                agv_rf_tag = data.rf_tag || 0;
                document.getElementById('current-speed').textContent = (data.current_speed !== undefined ? Math.round(data.current_speed) : '-') + ' mm/s';
            } catch (e) {}
        }
        setInterval(updateStatusPanel, 100);


        // AGV Warning Message Box
        async function checkWarning() {
            try {
                const res = await fetch('/check_warning');
                const data = await res.json();

                let estopType = '';
                let estopIcon = '';

                console.log(data.warning_type);
                console.log(data.msg);
                
                switch (data.warning_type) 
                {
                    case 'Push-estop':
                        estopType = 'ë¹„ìƒì •ì§€ ë²„íŠ¼';
                        estopIcon = 'ğŸ”´';
                        break;
                    case 'Srv-estop':
                        estopType = 'ì„œë²„ ë¹„ìƒì •ì§€';
                        estopIcon = 'ğŸš¨';
                        break;
                    case 'Obstacle-estop':
                        estopType = 'ì¥ì• ë¬¼ ê°ì§€';
                        estopIcon = 'âš ï¸';
                        break;
                        
                    case 'Abnormal':
                        estopType = 'ë¹„ì •ìƒ ìƒíƒœ';
                        estopIcon = 'â—';
                        break;
                }



                // ë©”ì‹œì§€ ë°•ìŠ¤ ë„ìš°ê¸°
                if (data && data.warning_type && data.warning_type !== 'Release-Obstacle' &&!document.getElementById('estop-warning')) {
                    const warningBox = document.createElement('div');
                    warningBox.id = 'estop-warning';
                    warningBox.style.position = 'fixed';
                    warningBox.style.top = '50%';
                    warningBox.style.left = '50%';
                    warningBox.style.transform = 'translate(-50%, -50%)';
                    warningBox.style.background = 'rgba(206, 65, 47, 0.95)';
                    warningBox.style.color = 'white';
                    warningBox.style.padding = '30px 50px';
                    warningBox.style.borderRadius = '12px';
                    warningBox.style.fontSize = '24px';
                    warningBox.style.fontWeight = 'bold';
                    warningBox.style.textAlign = 'center';
                    warningBox.style.zIndex = '10000';
                    warningBox.style.boxShadow = '0 8px 32px rgba(0,0,0,0.5)';
                    warningBox.innerHTML = `
                        ${estopIcon} ${estopType} ë°œìƒ ${estopIcon}<br>
                        <div style="font-size: 18px; margin-top: 15px; font-weight: normal;">
                            ${data.msg}<br>
                            ìƒí™©ì„ í™•ì¸í•˜ì‹œê³  AGVë¥¼ ì¡°ì‘í•´ì£¼ì„¸ìš”.
                        </div>
                        <button id="acknowledge-btn" style="
                            margin-top: 20px;
                            padding: 12px 30px;
                            font-size: 18px;
                            font-weight: bold;
                            background: white;
                            color: #1b1b1bff;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        ">í™•ì¸ ë° ì‹œìŠ¤í…œ ì¢…ë£Œ</button>
                    `;
                    document.body.appendChild(warningBox);
                    document.getElementById('acknowledge-btn').onclick = function() {
                        document.body.removeChild(warningBox);
                    };
                }
                // ë©”ì‹œì§€ ë°•ìŠ¤ í•´ì œ
                else if ((!data.warning_type || data.warning_type === 'Release-Obstacle') && document.getElementById('estop-warning')) {
                    document.body.removeChild(document.getElementById('estop-warning'));
                }
            } catch (e) {}
        }
        setInterval(checkWarning, 500);

        async function fetchData() {
            const pathRes = await fetch('/driving_path');
            const driving_path = await pathRes.json();
            const wpRes = await fetch('/waypoints');
            const waypointsRaw = await wpRes.json();
            // Only use waypoints with visible:true
            const waypoints = waypointsRaw.filter(wp => wp.visible === true);
            return { driving_path, waypoints };
        }

        function drawPath(ctx, path) {
            ctx.save();
            ctx.strokeStyle = '#cecb0a6c';
            ctx.lineWidth = 4;
            ctx.beginPath();
            path.forEach(seg => {
                if (seg.type === "line") {
                    ctx.moveTo(seg.x1, seg.y1);
                    ctx.lineTo(seg.x2, seg.y2);
                } else if (seg.type === "curve") {
                    const match = seg.d.match(/M (\d+) (\d+) Q (\d+) (\d+) (\d+) (\d+)/);
                    if (match) {
                        const [, x1, y1, cx, cy, x2, y2] = match.map(Number);
                        ctx.moveTo(x1, y1);
                        ctx.quadraticCurveTo(cx, cy, x2, y2);
                    }
                }
            });
            ctx.stroke();
            ctx.restore();
        }

        function drawWaypoints(ctx, points) {
            ctx.save();
            points.filter(wp => wp.visible === true).forEach(wp => {
                ctx.beginPath();
                ctx.arc(wp.x, wp.y, 2.0, 0, 2 * Math.PI); // 60% of 16px
                ctx.fillStyle = '#ff9800';
                ctx.fill();
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.stroke();
                // ìˆ«ì ì œê±°ë¨, ì‚¬ê°í˜•ì€ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì¶”ê°€
            });
            ctx.restore();
        }

        function drawTagID(ctx, points) {
            ctx.save();
            points.filter(wp => wp.visible === true).forEach(wp => {
                if (typeof wp.offset_x === 'number' && typeof wp.offset_y === 'number') {
                    const rectW = 24, rectH = 20;
                    const rectX = wp.x + wp.offset_x - rectW/2;
                    const rectY = wp.y + wp.offset_y - rectH/2;
                    // Draw black rectangle with white border
                    ctx.beginPath();
                    ctx.rect(rectX, rectY, rectW, rectH);
                    ctx.fillStyle = 'black';
                    ctx.fill();
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = 'white';
                    ctx.stroke();
                    // Draw id number in rectangle
                    ctx.fillStyle = 'white';
                    ctx.font = 'bold 14px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(wp.id, rectX + rectW/2, rectY + rectH/2);
                }
            });
            ctx.restore();
        }        

        // Draw AGV image at (x, y) with rotation
        function drawAGV(ctx, x, y, rotation=0, width=50, height=75, img) {
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(rotation);
            if (img && img.complete) {
                ctx.drawImage(img, -width/2, -height/2, width, height);
            }
            ctx.restore();
        }

        window.onload = async function() {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const { driving_path, waypoints } = await fetchData();

            // Populate dropdown with visible waypoints only
            const select = document.getElementById('waypointSelect');
            select.innerHTML = '';
            waypoints.forEach(wp => {
                const opt = document.createElement('option');
                opt.value = wp.id;
                opt.textContent = wp.id;
                select.appendChild(opt);
            });

            // Load AGV image
            const agvImg = new Image();
            agvImg.src = '/static/AGV.png';

            let allowedMoving = false; // AGV ì´ë™ ìƒíƒœ í”Œë˜ê·¸
            let moveCount = 0;    // GO ë²„íŠ¼ ì´í›„ ì¹´ìš´íŠ¸
            let smoothHeading = 0; // [ì‚­ì œ ìš©ì´] ë¶€ë“œëŸ¬ìš´ heading ë³€ìˆ˜(ì „ì—­)

            function lerp(a, b, t) {
                // ì„ í˜• ë³´ê°„ í•¨ìˆ˜
                return a + (b - a) * t;
            }

            function shortestAngleDiff(a, b) {
                // ë‘ ê°ë„ì˜ ìµœì†Œ ì°¨ì´(ë¼ë””ì•ˆ)
                let diff = b - a;
                while (diff < -Math.PI) diff += 2 * Math.PI;
                while (diff > Math.PI) diff -= 2 * Math.PI;
                return diff;
            }

            function render(agvPos) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                drawPath(ctx, driving_path);
                drawWaypoints(ctx, waypoints);
                drawTagID(ctx, waypoints);
                
                //console.log(agv_rf_tag);
                //console.log(moveCount);
                //console.log(allowedMoving);

                // [ì¤‘ìš” ì½”ë“œ ] heading ë¶€ë“œëŸ½ê²Œ ë³´ê°„ (ì†ë„ 0.07)
                // [ì¤‘ìš” ì½”ë“œ ] RF íƒœê·¸ 0 ì¼ ë•Œ AGVê°€ ëŒì•„ê°€ëŠ” í˜„ìƒ ë°©ì§€
                if (allowedMoving && moveCount >= 10 && agv_rf_tag > 1) 
                {
                    let targetHeading = agvPos.heading + Math.PI/2;
                    if (typeof smoothHeading !== 'number') smoothHeading = targetHeading;
                    let diff = shortestAngleDiff(smoothHeading, targetHeading);
                    smoothHeading = lerp(smoothHeading, smoothHeading + diff, 0.07); // ë” ëŠë¦¬ê²Œ íšŒì „
                    moveCount = 10; // ìµœëŒ€ì¹˜ ìœ ì§€
                }
                else 
                {
                    if (allowedMoving) moveCount++;
                    smoothHeading = 0;
                }

                drawAGV(ctx, agvPos.x, agvPos.y, smoothHeading, 100, 150, agvImg);

            }

            // Initial fetch and render
            let agvPos = {x: waypoints[0].x, y: waypoints[0].y, heading: 0} ; // Default position
            render(agvPos);

            // Poll AGV position every 30ms
            setInterval(async () => {
                try {
                    const res = await fetch('/agv_position');
                    agvPos = await res.json();
                    render(agvPos);
                } catch (e) {}
            }, 30);

            // GO ë²„íŠ¼ logic: move AGV to selected waypoint
            document.getElementById('goBtn').onclick = async function() {
                const select = document.getElementById('waypointSelect');
                const wpId = parseInt(select.value);

                allowedMoving = true; // GO ë²„íŠ¼ í´ë¦­ ì‹œ ì´ë™ ìƒíƒœë¡œ ë³€ê²½
                // POST to backend to set target waypoint
                await fetch('/set_cmd_agv', 
                {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({command: 'GO', wp_id: wpId})
                });
            };
            
            let bPushedPause = false;                                                       
            // Pause ë²„íŠ¼ logic
            document.getElementById('pauseBtn').onclick = async function() 
            {
                bPushedPause = !bPushedPause;

                this.textContent = (bPushedPause ?  "RESUME" : "PAUSE");
                const cmd = bPushedPause ? 'PAUSE' : 'RESUME';

                await fetch('/set_cmd_agv', 
                { 
                    method: 'POST' ,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({command: cmd})
                });            

            };

            // STOP ë²„íŠ¼ logic
            document.getElementById('stopBtn').onclick = async function() 
            {
                await fetch('/set_cmd_agv', { 
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({command: 'ESTOP'})
                });
            };    
        };

    </script>
</body>
</html>
