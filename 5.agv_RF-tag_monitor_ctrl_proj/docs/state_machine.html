<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AGV ìƒíƒœ ë¨¸ì‹  ë‹¤ì´ì–´ê·¸ë¨ - State Machine ê¸°ë°˜</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <style>
    body { font-family: Arial, sans-serif; background: #f7f8fb; color: #222; }
    .container { max-width: 1200px; margin: 30px auto; padding: 20px; background: #fff; border-radius: 10px; box-shadow: 0 6px 24px rgba(0,0,0,0.08); }
    h1 { margin-top: 0; font-size: 26px; color: #1e40af; }
    h2 { color: #374151; font-size: 20px; margin-top: 30px; }
    h3 { color: #4b5563; font-size: 16px; margin-top: 20px; }
    .meta { color: #666; font-size: 14px; margin-bottom: 16px; }
    .tips { background: #f1f7ff; border-left: 4px solid #3b82f6; padding: 12px 14px; border-radius: 6px; margin-bottom: 20px; }
    .warning { background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px 14px; border-radius: 6px; margin-bottom: 20px; }
    pre { background: #0b1021; color: #e6edf3; padding: 12px; border-radius: 8px; overflow-x: auto; font-size: 13px; }
    .state-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin: 20px 0; }
    .state-card { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; }
    .state-card h4 { margin: 0 0 8px 0; color: #1f2937; }
    .state-card .purpose { color: #6b7280; font-size: 13px; margin-bottom: 8px; }
    .state-card .actions { color: #374151; font-size: 13px; }
    ul { padding-left: 20px; }
    li { margin-bottom: 5px; }
    code { background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-family: 'Courier New', monospace; }
  </style>
  <script type="module">
    import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";
    mermaid.initialize({ startOnLoad: true, theme: 'default' });
  </script>
</head>
<body>
  <div class="container">
    <h1>ğŸ¤– AGV ìƒíƒœ ë¨¸ì‹  ë‹¤ì´ì–´ê·¸ë¨ (State Machine ê¸°ë°˜)</h1>
    <div class="meta">6ê°œ ì£¼ìš” ìƒíƒœ: Initial, Ready, Running, ESTOP ê³„ì—´, Completed, Abnormal</div>
    
    <div class="tips">
      <strong>ğŸ’¡ í•™ìŠµìš© State Machine Pattern</strong><br>
      ì´ ì‹œìŠ¤í…œì€ êµìœ¡ìš©ìœ¼ë¡œ ì„¤ê³„ëœ ëª…í™•í•œ ìƒíƒœ ì „ì´ êµ¬ì¡°ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. ê° ìƒíƒœì˜ ì—­í• ê³¼ ì „ì´ ì¡°ê±´ì„ ì‰½ê²Œ ì´í•´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </div>

    <div class="warning">
      <strong>ğŸ›‘ ì•ˆì „í•œ ì¢…ë£Œ</strong><br>
      SRV_ESTOPê³¼ ABNORMAL ìƒíƒœì—ì„œëŠ” í”„ë¡œê·¸ë¨ì´ ìë™ ì¢…ë£Œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì‚¬ìš©ìê°€ ì§ì ‘ 'q' + Enter ë˜ëŠ” Ctrl+Cë¡œ ì•ˆì „í•˜ê²Œ ì¢…ë£Œí•´ì•¼ í•©ë‹ˆë‹¤.
    </div>

    <div class="mermaid">
  flowchart TD
    %% ë©”ì¸ ìƒíƒœë“¤
    INITIAL[1. INITIAL<br/>ì´ˆê¸°í™”]
    READY[2. READY<br/>ì¤€ë¹„ ëŒ€ê¸°]
    RUNNING[3. RUNNING<br/>ë¼ì¸ íŠ¸ë ˆì´ì‹±]
    PAUSED[3-1. PAUSED<br/>ì¼ì‹œì •ì§€]
    RESUME[3-2. RESUME<br/>ì¬ê°œ]
    COMPLETED[5. COMPLETED<br/>ì„ë¬´ ì™„ë£Œ]
    
    %% ESTOP ìƒíƒœë“¤
    PUSH_ESTOP[4-1. PUSH_ESTOP<br/>ë¬¼ë¦¬ì  ë¹„ìƒì •ì§€]
    OBS_ESTOP[4-2. OBS_ESTOP<br/>ì¥ì• ë¬¼ ë¹„ìƒì •ì§€]
    SRV_ESTOP[4-3. SRV_ESTOP<br/>ì„œë²„ ë¹„ìƒì •ì§€]
    
    %% ë¹„ì •ìƒ ìƒíƒœ
    ABNORMAL[6. ABNORMAL<br/>ë¹„ì •ìƒ ìƒíƒœ]
    
    %% ì‚¬ìš©ì ì¢…ë£Œ
    USER_EXIT((ì‚¬ìš©ì ì¢…ë£Œ<br/>q + Enter<br/>Ctrl+C))

    %% ì´ˆê¸°í™” íë¦„
    INITIAL -->|ì—°ê²° ì„±ê³µ| READY
    INITIAL -->|ì—°ê²° ì‹¤íŒ¨| ABNORMAL
    
    %% ì •ìƒ ìš´ì˜ íë¦„
    READY -->|ì„œë²„ GO ëª…ë ¹| RUNNING
    RUNNING -->|Tag 1-9 ê°ì§€| RUNNING
    RUNNING -->|Tag 10 ê°ì§€| COMPLETED
    COMPLETED -->|ì„œë²„ GO ëª…ë ¹| READY
    
    %% ì¼ì‹œì •ì§€ íë¦„
    RUNNING -->|ì„œë²„ PAUSE| PAUSED
    PAUSED -->|ì„œë²„ RESUME| RESUME
    RESUME -->|ì¦‰ì‹œ ì „í™˜| RUNNING
    
    %% ì•ˆì „ ì‹œìŠ¤í…œ
    RUNNING -->|EmgFlag=1| PUSH_ESTOP
    RUNNING -->|LiDAR<200mm| OBS_ESTOP
    RUNNING -->|ì„œë²„ ESTOP| SRV_ESTOP
    
    %% ESTOP ë³µêµ¬
    PUSH_ESTOP -->|ìŠ¤ìœ„ì¹˜ í•´ì œ| RESUME
    OBS_ESTOP -->|ì¥ì• ë¬¼ ì œê±°| RESUME
    
    %% ëŒ€ê¸° ìƒíƒœë“¤ (ìˆ˜ë™ ì¢…ë£Œ í•„ìš”)
    SRV_ESTOP -->|ëŒ€ê¸° ìƒíƒœ| SRV_ESTOP
    ABNORMAL -->|ëŒ€ê¸° ìƒíƒœ| ABNORMAL
    
    %% ì‚¬ìš©ì ì¢…ë£Œ (ëª¨ë“  ìƒíƒœì—ì„œ ê°€ëŠ¥)
    SRV_ESTOP -.->|q/Ctrl+C| USER_EXIT
    ABNORMAL -.->|q/Ctrl+C| USER_EXIT
    READY -.->|q/Ctrl+C| USER_EXIT
    RUNNING -.->|q/Ctrl+C| USER_EXIT
    PAUSED -.->|q/Ctrl+C| USER_EXIT
    COMPLETED -.->|q/Ctrl+C| USER_EXIT

    %% ìŠ¤íƒ€ì¼ë§
    classDef main fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef estop fill:#ffebee,stroke:#d32f2f,stroke-width:2px
    classDef abnormal fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef exit fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef completed fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
    
    class INITIAL,READY,RUNNING,PAUSED,RESUME main
    class PUSH_ESTOP,OBS_ESTOP,SRV_ESTOP estop
    class ABNORMAL abnormal
    class USER_EXIT exit
    class COMPLETED completed
    </div>

    <h2>ğŸ“Š ìƒíƒœë³„ ìƒì„¸ ì •ë³´</h2>
    
    <div class="state-list">
      <div class="state-card">
        <h4>1ï¸âƒ£ INITIAL (ì´ˆê¸°í™”)</h4>
        <div class="purpose">ì‹œìŠ¤í…œ ì´ˆê¸°í™” ë° ì—°ê²° í…ŒìŠ¤íŠ¸</div>
        <div class="actions">
          â€¢ ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸<br>
          â€¢ í•˜ë“œì›¨ì–´(ì‹œë¦¬ì–¼) ì—°ê²° í…ŒìŠ¤íŠ¸<br>
          â€¢ ì„±ê³µ ì‹œ â†’ READY<br>
          â€¢ ì‹¤íŒ¨ ì‹œ â†’ ABNORMAL
        </div>
      </div>

      <div class="state-card">
        <h4>2ï¸âƒ£ READY (ì¤€ë¹„)</h4>
        <div class="purpose">ì‹œì‘ ëª…ë ¹ ëŒ€ê¸°</div>
        <div class="actions">
          â€¢ tag1 = 0, tag2 = 100mm/s<br>
          â€¢ ëª¨í„° ì •ì§€ ìƒíƒœ<br>
          â€¢ ì„œë²„ GO ëª…ë ¹ ì‹œ â†’ RUNNING
        </div>
      </div>

      <div class="state-card">
        <h4>3ï¸âƒ£ RUNNING (ì£¼í–‰)</h4>
        <div class="purpose">ë¼ì¸ íŠ¸ë ˆì´ì‹± ë° ì„ë¬´ ìˆ˜í–‰</div>
        <div class="actions">
          â€¢ ë¼ì¸ íŠ¸ë ˆì´ì‹± ì§€ì† ìˆ˜í–‰<br>
          â€¢ tag1=0: ê¸°ë³¸ì†ë„ 100mm/s<br>
          â€¢ tag1â‰¥2: ì‚¬ìš©ìì†ë„(tag2)<br>
          â€¢ Tag 10 ê°ì§€ ì‹œ â†’ COMPLETED
        </div>
      </div>

      <div class="state-card">
        <h4>3ï¸âƒ£-1ï¸âƒ£ PAUSED (ì¼ì‹œì •ì§€)</h4>
        <div class="purpose">ì¼ì‹œ ì •ì§€ ìƒíƒœ</div>
        <div class="actions">
          â€¢ ì†ë„ 0, í˜„ì¬ ìœ„ì¹˜ ìœ ì§€<br>
          â€¢ RESUME ëª…ë ¹ ì‹œ â†’ RUNNING
        </div>
      </div>

      <div class="state-card">
        <h4>4ï¸âƒ£-1ï¸âƒ£ PUSH_ESTOP</h4>
        <div class="purpose">ë¬¼ë¦¬ì  ë¹„ìƒì •ì§€</div>
        <div class="actions">
          â€¢ AGV ë¹„ìƒì •ì§€ ìŠ¤ìœ„ì¹˜ í™œì„±í™”<br>
          â€¢ ì™„ì „ ì •ì§€<br>
          â€¢ í•´ì œ ì‹œ â†’ RESUME
        </div>
      </div>

      <div class="state-card">
        <h4>4ï¸âƒ£-2ï¸âƒ£ OBS_ESTOP</h4>
        <div class="purpose">ì¥ì• ë¬¼ ë¹„ìƒì •ì§€</div>
        <div class="actions">
          â€¢ ë¼ì´ë‹¤ ê±°ë¦¬ < 200mm<br>
          â€¢ ì™„ì „ ì •ì§€<br>
          â€¢ ì¥ì• ë¬¼ ì œê±° ì‹œ â†’ RESUME
        </div>
      </div>

      <div class="state-card">
        <h4>4ï¸âƒ£-3ï¸âƒ£ SRV_ESTOP</h4>
        <div class="purpose">ì„œë²„ ë¹„ìƒì •ì§€</div>
        <div class="actions">
          â€¢ ì„œë²„ì—ì„œ ESTOP ëª…ë ¹<br>
          â€¢ ì™„ì „ ì •ì§€ ë° ëŒ€ê¸°<br>
          â€¢ ìˆ˜ë™ ì¢…ë£Œ í•„ìš” (q/Ctrl+C)
        </div>
      </div>

      <div class="state-card">
        <h4>5ï¸âƒ£ COMPLETED (ì™„ë£Œ)</h4>
        <div class="purpose">ì„ë¬´ ì™„ë£Œ ìƒíƒœ</div>
        <div class="actions">
          â€¢ Tag 10 ê°ì§€ë¡œ ì „í™˜<br>
          â€¢ ì •ì§€ ë° ëŒ€ê¸°<br>
          â€¢ ì„œë²„ GO ëª…ë ¹ ì‹œ â†’ READY (ì¬ì‹œì‘)
        </div>
      </div>

      <div class="state-card">
        <h4>6ï¸âƒ£ ABNORMAL (ë¹„ì •ìƒ)</h4>
        <div class="purpose">ì˜¤ë¥˜ ìƒíƒœ</div>
        <div class="actions">
          â€¢ ì´ˆê¸°í™” ì‹¤íŒ¨ì‹œ ì „í™˜<br>
          â€¢ ì™„ì „ ì •ì§€ ë° ëŒ€ê¸°<br>
          â€¢ ìˆ˜ë™ ì¢…ë£Œ í•„ìš” (q/Ctrl+C)
        </div>
      </div>
    </div>

    <h2>ğŸ”— ëª…ë ¹ ë§¤í•‘</h2>
    <ul>
      <li><strong>GO</strong> â†’ <code>POST /start</code> (READYâ†’RUNNING, COMPLETEDâ†’READY)</li>
      <li><strong>PAUSE</strong> â†’ <code>POST /pause</code> (RUNNINGâ†’PAUSED)</li>
      <li><strong>RESUME</strong> â†’ <code>POST /resume</code> (PAUSEDâ†’RESUMEâ†’RUNNING)</li>
      <li><strong>E-STOP</strong> â†’ <code>POST /estop</code> (â†’SRV_ESTOP)</li>
      <li><strong>E-STOP Release</strong> â†’ <code>POST /estop_release</code> (PUSH_ESTOP/OBS_ESTOPâ†’RESUME)</li>
    </ul>

    <h2>ğŸ·ï¸ RF-Tag í™œìš©</h2>
    <ul>
      <li><strong>Tag1 (ì„ë¬´ ì œì–´)</strong>: 0=ë¯¸ê°ì§€, 1=ì‹œì‘ì , 2-9=ì„ë¬´êµ¬ì—­, 10=ì™„ë£Œì </li>
      <li><strong>Tag2 (ì†ë„ ì œì–´)</strong>: 0=ì •ì§€, 1-200=ì†ë„ì œí•œ(mm/s)</li>
    </ul>

    <h2>ğŸ“Š ì†ë„ ì œì–´ ë¡œì§</h2>
    <pre><code>if agv_status in ("Ready", "Initial") or tag1_state == 0:
    ìµœëŒ€ì†ë„ = 100mm/s  # ì•ˆì „ ì €ì†
else:
    ìµœëŒ€ì†ë„ = min(ì‚¬ìš©ìì†ë„, tag2ì†ë„, 200mm/s)</code></pre>

    <h2>ğŸ›‘ í”„ë¡œê·¸ë¨ ì¢…ë£Œ ë°©ë²•</h2>
    <ul>
      <li><strong>'q' + Enter</strong>: í„°ë¯¸ë„ì—ì„œ ì •ìƒ ì¢…ë£Œ</li>
      <li><strong>Ctrl+C</strong>: í‚¤ë³´ë“œ ì¸í„°ëŸ½íŠ¸ë¡œ ê°•ì œ ì¢…ë£Œ</li>
      <li><strong>ìë™ ì¢…ë£Œ ì—†ìŒ</strong>: SRV_ESTOP, ABNORMAL ìƒíƒœì—ì„œ ëŒ€ê¸°</li>
    </ul>

    <h2>ğŸ¯ í•™ìŠµ í¬ì¸íŠ¸</h2>
    <ul>
      <li><strong>State Machine Pattern</strong>: ëª…í™•í•œ ìƒíƒœ ë¶„ë¦¬ì™€ ì „ì´ ì¡°ê±´</li>
      <li><strong>ë‹¤ì¤‘ ì•ˆì „ ì‹œìŠ¤í…œ</strong>: í•˜ë“œì›¨ì–´/ì†Œí”„íŠ¸ì›¨ì–´/ì„œë²„ ESTOP</li>
      <li><strong>ëª¨ë“ˆí™” ì„¤ê³„</strong>: ê¸°ëŠ¥ë³„ í•¨ìˆ˜ ë¶„ë¦¬</li>
      <li><strong>ì‹¤ì‹œê°„ ì œì–´</strong>: 100ms ì£¼ê¸° ì œì–´ ë£¨í”„</li>
      <li><strong>ì•ˆì „í•œ ì¢…ë£Œ</strong>: ì‚¬ìš©ì ì œì–´ ì¢…ë£Œ ì‹œìŠ¤í…œ</li>
    </ul>

    <h2>ğŸ› ï¸ ì£¼ìš” í•¨ìˆ˜</h2>
    <ul>
      <li><code>state_machine()</code>: ë©”ì¸ ìƒíƒœ ë¨¸ì‹  ë¡œì§</li>
      <li><code>line_following_control()</code>: ë¼ì¸ íŠ¸ë ˆì´ì‹± ì•Œê³ ë¦¬ì¦˜</li>
      <li><code>process_user_mission()</code>: ì‚¬ìš©ì ì„ë¬´ ì²˜ë¦¬</li>
      <li><code>check_user_input()</code>: ì‚¬ìš©ì ì¢…ë£Œ ì…ë ¥ ê°ì§€</li>
      <li><code>send_motor_command()</code>: ëª¨í„° ì œì–´</li>
      <li><code>get_sensor_data()</code>: ì„¼ì„œ ë°ì´í„° íšë“</li>
    </ul>

    <div class="tips">
      <strong>ğŸ“ ê°œë°œ íŒ</strong><br>
      â€¢ ê° ìƒíƒœë³„ ë™ì‘ì„ ë‹¨ê³„ì ìœ¼ë¡œ í…ŒìŠ¤íŠ¸<br>
      â€¢ í„°ë¯¸ë„ ë¡œê·¸ë¡œ ìƒíƒœ ì „ì´ ëª¨ë‹ˆí„°ë§<br>
      â€¢ process_user_mission() í•¨ìˆ˜ì—ì„œ ì„ë¬´ ë¡œì§ í™•ì¥<br>
      â€¢ ì•ˆì „ì„ ìœ„í•´ í•­ìƒ ì •ìƒ ì¢…ë£Œ ë°©ë²• ì‚¬ìš©
    </div>

  </div>
</body>
</html>
