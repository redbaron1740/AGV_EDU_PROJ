<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGV ê²½ë¡œ ì‹œê°í™”</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
        }
        #canvas {
            border: 2px solid #333;
            background-color: white;
            display: block;
            margin: 20px auto;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .info {
            max-width: 1600px;
            margin: 20px auto;
            padding: 15px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .legend-color {
            width: 30px;
            height: 20px;
            border: 1px solid #333;
        }
    </style>
</head>
<body>
    <h1 style="text-align: center;">AGV ì£¼í–‰ ê²½ë¡œ ì‹œê°í™”</h1>
    
    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background-color: gray;"></div>
            <span>ì‹¤ì œ ì£¼í–‰ ê²½ë¡œ (Driving Path)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: orange; border-style: dashed;"></div>
            <span>íƒœê·¸ ì—°ê²° ê²½ë¡œ (Tag Route)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: red; border-radius: 50%;"></div>
            <span>RF íƒœê·¸ ìœ„ì¹˜ (RF Tags)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: blue;"></div>
            <span>AGV (ì• ë‹ˆë©”ì´ì…˜)</span>
        </div>
    </div>
    
    <div style="text-align: center; margin: 10px 0; color: #666;">
        ğŸ’¡ í‚¤ë³´ë“œ: 1~0 = íƒœê·¸ ìœ„ì¹˜ë¡œ ë¦¬ì…‹ | ìŠ¤í˜ì´ìŠ¤ë°” = ì¼ì‹œì •ì§€/ì¬ìƒ
    </div>
    
    <canvas id="canvas" width="1600" height="700"></canvas>
    
    <div class="info">
        <h3>ê²½ë¡œ ì •ë³´</h3>
        <div id="pathInfo"></div>
        <h3>íƒœê·¸ ì •ë³´</h3>
        <div id="tagInfo"></div>
    </div>

    <script>
        // ê²½ë¡œ ë°ì´í„° (agv_station_server.pyì˜ ì‹¤ì œ driving_pathì™€ ë™ì¼)
        const driving_path = [
            {"type": "line",  "x1": 1491, "y1": 620, "x2": 1491, "y2": 375},
            {"type": "curve", "d": "M 1491 375 Q 1487 310 1416 300"},
            {"type": "line",  "x1": 1416, "y1": 300, "x2": 918,  "y2": 300},
            {"type": "line",  "x1": 920,  "y1": 300, "x2": 843,  "y2": 248},
            {"type": "line",  "x1": 844,  "y1": 248, "x2": 680,  "y2": 248},
            {"type": "line",  "x1": 680,  "y1": 248, "x2": 605,  "y2": 300},
            {"type": "line",  "x1": 605,  "y1": 300, "x2": 180,  "y2": 300},
            {"type": "curve", "d": "M 181 300 Q 132 310 116 375"},
            {"type": "line",  "x1": 116,  "y1": 375, "x2": 116,  "y2": 620}
        ];

        // RF íƒœê·¸ ìœ„ì¹˜ (ì„ì˜ ë°°ì¹˜ - ê²½ë¡œ ë²•ì„  ë°©í–¥ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì˜¤í”„ì…‹)
        // ì˜ˆ: 1, 2, 3, 4, 7, 8, 9, 10ë²ˆë§Œ ì‚¬ìš© (8ê°œ)
        const RF_TAGS = [
            { "id": 1,  "x": 1520, "y": 620, "visible": true, "location": "right" },  // ê²½ë¡œ ì˜¤ë¥¸ìª½
            { "id": 2,  "x": 1520, "y": 450, "visible": true, "location": "right" },  // ê²½ë¡œ ì˜¤ë¥¸ìª½
            { "id": 3,  "x": 1300, "y": 270, "visible": true, "location": "right" },  // ê²½ë¡œ ì˜¤ë¥¸ìª½
            { "id": 4,  "x": 1000, "y": 270, "visible": true, "location": "right" }, // ê²½ë¡œ ì˜¤ë¥¸ìª½
            { "id": 7,  "x": 500,  "y": 270, "visible": true, "location": "right" }, // ê²½ë¡œ ì˜¤ë¥¸ìª½
            { "id": 8,  "x": 200,  "y": 270, "visible": true, "location": "right" }, // ê²½ë¡œ ì˜¤ë¥¸ìª½
            { "id": 9,  "x": 90,   "y": 450, "visible": true, "location": "right" }, // ê²½ë¡œ ì™¼ìª½
            { "id": 10, "x": 90,   "y": 620, "visible": true, "location": "right" }  // ê²½ë¡œ ì™¼ìª½
        ];

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // AGV ì• ë‹ˆë©”ì´ì…˜ ìƒíƒœ
        let agvPosition = { x: 1491, y: 620 };  // ì‹œì‘ ìœ„ì¹˜ (Tag 1)
        let agvAngle = 0;  // AGV ë°©í–¥ (ë¼ë””ì•ˆ)
        let pathProgress = 0;  // ê²½ë¡œ ì§„í–‰ë¥  (0~1)
        let currentSegmentIndex = 0;  // í˜„ì¬ ì„¸ê·¸ë¨¼íŠ¸ ì¸ë±ìŠ¤
        let isAnimating = false;  // ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰ ì—¬ë¶€
        let animationSpeed = 1.5;  // ì†ë„ (í”½ì…€/í”„ë ˆì„)

        // SVG path íŒŒì‹± í•¨ìˆ˜
        function parseSVGPath(d) {
            const nums = d.match(/[-+]?[0-9]*\.?[0-9]+/g).map(Number);
            return {
                start: [nums[0], nums[1]],
                control: [nums[2], nums[3]],
                end: [nums[4], nums[5]]
            };
        }

        // ê²½ë¡œ ê·¸ë¦¬ê¸°
        function drawPath() {
            // 1. ì‹¤ì œ ì£¼í–‰ ê²½ë¡œ (íšŒìƒ‰, ë‘êº¼ìš´ ì„  - index.htmlê³¼ ë™ì¼)
            ctx.strokeStyle = 'gray';
            ctx.lineWidth = 5;
            ctx.setLineDash([]);
            
            driving_path.forEach(segment => {
                if (segment.type === 'line') {
                    ctx.beginPath();
                    ctx.moveTo(segment.x1, segment.y1);
                    ctx.lineTo(segment.x2, segment.y2);
                    ctx.stroke();
                } else if (segment.type === 'curve') {
                    const parsed = parseSVGPath(segment.d);
                    ctx.beginPath();
                    ctx.moveTo(parsed.start[0], parsed.start[1]);
                    ctx.quadraticCurveTo(
                        parsed.control[0], parsed.control[1],
                        parsed.end[0], parsed.end[1]
                    );
                    ctx.stroke();
                }
            });
            
            // 2. íƒœê·¸ ì—°ê²°ì„  ê·¸ë¦¬ê¸° (ì£¼í™©ìƒ‰ ì ì„ )
            ctx.strokeStyle = 'orange';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            
            // íƒœê·¸ë“¤ì„ ìˆœì„œëŒ€ë¡œ ì—°ê²° (ë°°ì—´ ìˆœì„œëŒ€ë¡œ)
            ctx.beginPath();
            ctx.moveTo(RF_TAGS[0].x, RF_TAGS[0].y);
            for (let i = 1; i < RF_TAGS.length; i++) {
                ctx.lineTo(RF_TAGS[i].x, RF_TAGS[i].y);
            }
            ctx.stroke();
            
            ctx.setLineDash([]);  // ì ì„  í•´ì œ
        }

        // íƒœê·¸ ê·¸ë¦¬ê¸° (ë¹¨ê°„ ì› + ë²ˆí˜¸)
        function drawTags() {
            RF_TAGS.forEach(tag => {
                // íƒœê·¸ ì› ê·¸ë¦¬ê¸°
                ctx.fillStyle = 'red';
                ctx.beginPath();
                ctx.arc(tag.x, tag.y, 8, 0, 2 * Math.PI);
                ctx.fill();
                
                // íƒœê·¸ ë²ˆí˜¸ í‘œì‹œ (í°ìƒ‰ í…Œë‘ë¦¬ + ê²€ì€ìƒ‰ í…ìŠ¤íŠ¸)
                ctx.font = 'bold 14px Arial';
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 3;
                ctx.strokeText(tag.id.toString(), tag.x + 15, tag.y + 5);
                ctx.fillStyle = 'black';
                ctx.fillText(tag.id.toString(), tag.x + 15, tag.y + 5);
            });
        }

        // AGV ê·¸ë¦¬ê¸° (ê°„ë‹¨í•œ ì‚¼ê°í˜•)
        function drawAGV() {
            ctx.save();
            ctx.translate(agvPosition.x, agvPosition.y);
            ctx.rotate(agvAngle);
            
            // AGV ëª¸ì²´ (ì‚¼ê°í˜•)
            ctx.fillStyle = 'blue';
            ctx.beginPath();
            ctx.moveTo(15, 0);      // ì•
            ctx.lineTo(-10, -8);    // ì™¼ìª½ ë’¤
            ctx.lineTo(-10, 8);     // ì˜¤ë¥¸ìª½ ë’¤
            ctx.closePath();
            ctx.fill();
            
            // í…Œë‘ë¦¬
            ctx.strokeStyle = 'darkblue';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            ctx.restore();
        }

        // ê²½ë¡œ ìƒì˜ ìœ„ì¹˜ ê³„ì‚°
        function getPositionOnPath(segmentIndex, t) {
            if (segmentIndex >= driving_path.length) {
                return null;
            }
            
            const segment = driving_path[segmentIndex];
            
            if (segment.type === 'line') {
                const x = segment.x1 + (segment.x2 - segment.x1) * t;
                const y = segment.y1 + (segment.y2 - segment.y1) * t;
                const angle = Math.atan2(segment.y2 - segment.y1, segment.x2 - segment.x1);
                return { x, y, angle };
            } else if (segment.type === 'curve') {
                const parsed = parseSVGPath(segment.d);
                const x0 = parsed.start[0];
                const y0 = parsed.start[1];
                const cx = parsed.control[0];
                const cy = parsed.control[1];
                const x1 = parsed.end[0];
                const y1 = parsed.end[1];
                
                // Quadratic Bezier ê³µì‹
                const mt = 1 - t;
                const x = mt * mt * x0 + 2 * mt * t * cx + t * t * x1;
                const y = mt * mt * y0 + 2 * mt * t * cy + t * t * y1;
                
                // ì ‘ì„  ë°©í–¥ ê³„ì‚°
                const dx = 2 * mt * (cx - x0) + 2 * t * (x1 - cx);
                const dy = 2 * mt * (cy - y0) + 2 * t * (y1 - cy);
                const angle = Math.atan2(dy, dx);
                
                return { x, y, angle };
            }
            
            return null;
        }

        // ì„¸ê·¸ë¨¼íŠ¸ ê¸¸ì´ ê³„ì‚°
        function getSegmentLength(segmentIndex) {
            const segment = driving_path[segmentIndex];
            
            if (segment.type === 'line') {
                const dx = segment.x2 - segment.x1;
                const dy = segment.y2 - segment.y1;
                return Math.sqrt(dx * dx + dy * dy);
            } else if (segment.type === 'curve') {
                // ê³¡ì„  ê·¼ì‚¬ ê¸¸ì´ (ìƒ˜í”Œë§)
                let length = 0;
                const steps = 50;
                let prevPos = getPositionOnPath(segmentIndex, 0);
                
                for (let i = 1; i <= steps; i++) {
                    const t = i / steps;
                    const pos = getPositionOnPath(segmentIndex, t);
                    const dx = pos.x - prevPos.x;
                    const dy = pos.y - prevPos.y;
                    length += Math.sqrt(dx * dx + dy * dy);
                    prevPos = pos;
                }
                
                return length;
            }
            
            return 0;
        }

        // AGV ì• ë‹ˆë©”ì´ì…˜ ì—…ë°ì´íŠ¸
        function updateAGV() {
            if (!isAnimating) return;
            
            // í˜„ì¬ ì„¸ê·¸ë¨¼íŠ¸ ê¸¸ì´
            const segmentLength = getSegmentLength(currentSegmentIndex);
            
            // ì§„í–‰ë¥  ì¦ê°€
            pathProgress += animationSpeed / segmentLength;
            
            // ì„¸ê·¸ë¨¼íŠ¸ ì™„ë£Œ ì‹œ ë‹¤ìŒ ì„¸ê·¸ë¨¼íŠ¸ë¡œ
            if (pathProgress >= 1.0) {
                pathProgress = 0;
                currentSegmentIndex++;
                
                // ëª¨ë“  ê²½ë¡œ ì™„ë£Œ ì‹œ ì²˜ìŒìœ¼ë¡œ
                if (currentSegmentIndex >= driving_path.length) {
                    currentSegmentIndex = 0;
                }
            }
            
            // í˜„ì¬ ìœ„ì¹˜ ê³„ì‚°
            const pos = getPositionOnPath(currentSegmentIndex, pathProgress);
            if (pos) {
                agvPosition.x = pos.x;
                agvPosition.y = pos.y;
                agvAngle = pos.angle;
            }
        }

        // íƒœê·¸ IDë¡œ AGV ìœ„ì¹˜ ë¦¬ì…‹ (ì‹¤ì œ RF-Tag ê°ì§€ ì‹œ í˜¸ì¶œ)
        function resetAGVToTag(tagId) {
            const tag = RF_TAGS.find(t => t.id === tagId);
            if (tag) {
                agvPosition.x = tag.x;
                agvPosition.y = tag.y;
                console.log(`ğŸ·ï¸ AGV ìœ„ì¹˜ ë¦¬ì…‹: Tag ${tagId} (${tag.x}, ${tag.y})`);
            }
        }

        // ì• ë‹ˆë©”ì´ì…˜ ë£¨í”„
        function animate() {
            // ìº”ë²„ìŠ¤ í´ë¦¬ì–´
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ê·¸ë¦¬ê¸°
            drawPath();
            drawTags();
            drawAGV();
            
            // ì—…ë°ì´íŠ¸
            updateAGV();
            
            // ë‹¤ìŒ í”„ë ˆì„
            requestAnimationFrame(animate);
        }

        // ì •ë³´ í‘œì‹œ
        function displayInfo() {
            let pathHTML = '<table border="1" cellpadding="5" style="border-collapse: collapse; width: 100%;">';
            pathHTML += '<tr><th>Segment</th><th>Type</th><th>Description</th></tr>';
            
            driving_path.forEach((seg, idx) => {
                let desc = '';
                if (seg.type === 'line') {
                    desc = `(${seg.x1}, ${seg.y1}) â†’ (${seg.x2}, ${seg.y2})`;
                } else if (seg.type === 'curve') {
                    desc = `Bezier: ${seg.d}`;
                }
                pathHTML += `<tr>
                    <td>Seg ${idx}</td>
                    <td>${seg.type}</td>
                    <td>${desc}</td>
                </tr>`;
            });
            pathHTML += '</table>';
            document.getElementById('pathInfo').innerHTML = pathHTML;
            
            let tagHTML = '<table border="1" cellpadding="5" style="border-collapse: collapse; width: 100%;">';
            tagHTML += '<tr><th>Tag ID</th><th>X</th><th>Y</th><th>Visible</th><th>Location</th><th>Status</th></tr>';
            
            RF_TAGS.forEach(tag => {
                const statusColor = tag.visible ? 'background-color: #ffcccc;' : 'background-color: #f0f0f0;';
                const visibleText = tag.visible ? 'âœ“ í™œì„±' : 'âœ— ë¹„í™œì„±';
                tagHTML += `<tr style="${statusColor}">
                    <td><strong>Tag ${tag.id}</strong></td>
                    <td>${tag.x}</td>
                    <td>${tag.y}</td>
                    <td>${visibleText}</td>
                    <td>${tag.location}</td>
                    <td>${tag.visible ? 'ì‚¬ìš© ì¤‘' : 'ì‚¬ìš© ì•ˆ í•¨'}</td>
                </tr>`;
            });
            tagHTML += '</table>';
            document.getElementById('tagInfo').innerHTML = tagHTML;
        }

        // ì‹¤í–‰
        displayInfo();
        
        // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
        isAnimating = true;
        animate();
        
        // í…ŒìŠ¤íŠ¸: í‚¤ë³´ë“œë¡œ íƒœê·¸ ë¦¬ì…‹ (1~10ë²ˆ í‚¤)
        document.addEventListener('keydown', (e) => {
            const tagId = parseInt(e.key);
            if (tagId >= 1 && tagId <= 10) {
                resetAGVToTag(tagId);
            } else if (e.key === ' ') {
                // ìŠ¤í˜ì´ìŠ¤ë°”: ì• ë‹ˆë©”ì´ì…˜ í† ê¸€
                isAnimating = !isAnimating;
            }
        });
    </script>
</body>
</html>
