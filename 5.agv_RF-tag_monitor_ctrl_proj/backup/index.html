<!DOCTYPE html>
<html>
<head>
    <title>AGV Monitoring Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
        }
        .content {
            width: 1600px;
            margin: auto;
            padding: 10px;
        }
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }
        .header-container .button-group-center {
            display: flex;
            gap: 10px;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        .header-container .button-group-right {
            display: flex;
        }
        .header-container h1 {
            margin: 0;
            font-size: 24px;
        }
        .lan-tip {
            margin-left: 12px;
            font-size: 12px;
            color: #0b7285;
            background: #e3fafc;
            border: 1px solid #99e9f2;
            padding: 4px 8px;
            border-radius: 6px;
            display: none; /* JSì—ì„œ í•„ìš” ì‹œ í‘œì‹œ */
        }
        .header-container button#emergencyBtn {
            background-color: #d32f2f;
            border-radius: 90%;
            padding: 0;
            position: relative;
            background-image: url('/static/stop.png');
            background-size: 120%;
            background-repeat: no-repeat;
            background-position: center;
            width: 50px;
            height: 50px;
        }
        .header-container button#emergencyBtn:hover {
            background-color: #b71c1c;
        }
        .header-container button {
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            background-color: #4CAF50;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .header-container button:hover {
            background-color: #45a049;
        }
        .header-container button#pauseBtn {
            background-color: #FF9800;
        }
        .header-container button#pauseBtn:hover {
            background-color: #F57C00;
        }
        .header-container button#homeBtn {
            background-color: #2196F3;
        }
        .header-container button#homeBtn:hover {
            background-color: #1976D2;
        }
        .map-container {
            position: relative;
            width: 1600px;
            height: 763px;
            margin: auto;
            background-image: url('/static/background.jpg');
            background-size: 1600px 763px;
            background-repeat: no-repeat;
            background-position: center;
            border: 2px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .agv-image {
            position: absolute;
            width: 80px;
            height: 140px;
            left: 1491px;
            top: 620px;
            transform: translate(-50%, -50%) rotate(0deg);
            transition: left 0.1s linear, top 0.1s linear, transform 0.5s ease;
        }
        .path-layer, .trajectory-layer {
            position: absolute;
            left: 0;
            top: 0;
            width: 1600px;
            height: 763px;
            pointer-events: none;
        }
        .rf-tag {
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: #ff6b6b;
            border-radius: 50%;
            border: 3px solid #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .rf-tag.start-point {
            background-color: #28a745;
            border-color: #1e7e34;
            animation: pulse-green 1.5s infinite;
        }
        .rf-tag.end-point {
            background-color: #dc3545;
            border-color: #c82333;
            animation: pulse-red 1.5s infinite;
        }
        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
        }
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
        }
        .rf-tag-passed {
            animation: blink-passed 1s ease-in-out infinite;
        }
        @keyframes blink-passed {
            0%, 100% { 
                background-color: #ffc107;
                border-color: #ff9800;
                transform: scale(1);
            }
            50% { 
                background-color: #ffeb3b;
                border-color: #ffc107;
                transform: scale(1.2);
            }
        }
        .status-panel {
            position: absolute;
            top: 10%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255,255,255,0.95);
            border-radius: 12px;
            padding: 20px 30px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            min-width: 500px;
        }
        /* Tag numbers (2~9) squares: bigger, black, thin outline, number inside */
        .tag-num {
            position: absolute;
            width: 22px;
            height: 22px;
            background: #000;
            border: 1px solid #fff; /* thin outline */
            color: #fff;            /* number color */
            font-size: 12px;
            line-height: 22px;
            text-align: center;
            font-weight: 700;
            border-radius: 3px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.4);
            user-select: none;
        }
        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px 30px;
        }
        .status-item {
            display: flex;
            align-items: center;
            font-size: 16px;
        }
        .status-item strong {
            min-width: 90px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="content">
                <div class="header-container">
            <h1>AGV Monitoring Dashboard</h1>
            <div class="button-group-center">
                <button type="button" id="goBtn" onclick="handleGo()">GO</button>
                <label for="tagSelect" style="margin-left:12px; margin-right:8px;">Tag ID:</label>
                <select id="tagSelect" style="margin-right:16px;">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                </select>
                <button type="button" id="pauseBtn" onclick="handlePauseResume()">Pause</button>
                <span id="lan-tip" class="lan-tip">LAN ì ‘ì†: <a id="lan-link" href="#" target="_blank"></a></span>
            </div>
            <div class="button-group-right">
                <button type="button" id="emergencyBtn" onclick="handleEmergency()"></button>
            </div>
        </div>

        <div class="map-container">
            <!-- ê³ ì • ì£¼í–‰ ë¼ì¸ ë ˆì´ì–´ -->
            <svg class="path-layer">
                        <!-- Controls should be outside the for loop -->
                        <label for="stateSelect" style="margin-right:8px;">AGV ìƒíƒœ:</label>
                        <select id="stateSelect" style="margin-right:16px;">
                            <option value="Initial">Initial</option>
                            <option value="Ready">Ready</option>
                            <option value="Running">Running</option>
                            <option value="Push-EStop">Push-EStop</option>
                            <option value="OBS-EStop">OBS-EStop</option>
                        </select>
                        {% for segment in driving_path %}
                            {% if segment.type == 'line' %}
                                <line x1="{{ segment.x1 }}" y1="{{ segment.y1 }}" x2="{{ segment.x2 }}" y2="{{ segment.y2 }}" stroke="gray" stroke-width="5" />
                            {% elif segment.type == 'curve' %}
                                <path d="{{ segment.d }}" stroke="gray" stroke-width="5" fill="none" />
                            {% endif %}
                        {% endfor %}
            </svg>

            <!-- Tag Numbers (2~9) í‘œì‹œ: ì‘ì€ ì‚¬ê°í˜•ê³¼ ë¼ë²¨ -->
            <div id="tag-num-container"></div>

            <!-- AGV ì´ë™ ê²½ë¡œ(trajectory) ë ˆì´ì–´ -->
            <svg id="trajectory-svg" class="trajectory-layer"></svg>

            <!-- AGV ì´ë¯¸ì§€ -->
            <img id="agv" src="/static/AGV.png" alt="AGV Image" class="agv-image" />
            
            <!-- ìƒíƒœ íŒ¨ë„ -->
            <div class="status-panel" id="status-panel">
                <div class="status-grid">
                    <div class="status-item">
                        <strong>AGV ìƒíƒœ:</strong>
                        <span id="agv-status">IDLE</span>
                    </div>
                    <div class="status-item">
                        <strong>RF-Tag:</strong>
                        <span id="current-tag">-</span>
                    </div>
                    <div class="status-item">
                        <strong>ë°°í„°ë¦¬:</strong>
                        <span id="battery-level">100%</span>
                    </div>
                    <div class="status-item">
                        <strong>ì œí•œ ì†ë„:</strong>
                        <span id="speed-limit">200 mm/s</span>
                    </div>
                    <div class="status-item">
                        <strong>ì¥ì• ë¬¼:</strong>
                        <span id="lidar-distance">- mm</span>
                    </div>
                    <div class="status-item">
                        <strong>í˜„ì¬ ì†ë„:</strong>
                        <span id="current-speed">0 mm/s</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // AGV ì• ë‹ˆë©”ì´ì…˜ ì„¤ì •
        // ========================================
        const CONFIG = {
            AGV_ANIMATION_SPEED_BASE: 2.0, // ê¸°ì¤€ ì†ë„ (200mm/sì¼ ë•Œ) í”½ì…€/í”„ë ˆì„ (1.5â†’3.0 2ë°° ë¹ ë¥´ê²Œ)
            TAG_ARRIVAL_THRESHOLD: 50,     // íƒœê·¸ ë„ì°© íŒì • ê±°ë¦¬ (í”½ì…€)
            WAIT_AT_TAG: true               // íƒœê·¸ì—ì„œ ëŒ€ê¸° ì—¬ë¶€
        };

        // AGV ì• ë‹ˆë©”ì´ì…˜ ìƒíƒœ
        // íƒœê·¸ ì„ íƒ ì‹œ ì„œë²„ì— ì „ì†¡ + AGV ì• ë‹ˆë©”ì´ì…˜ ì´ë™
        document.getElementById('tagSelect').addEventListener('change', function() {
            const tagId = this.value;
            fetch('/set_tag', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tag_id: tagId })
            }).then(res => res.json()).then(data => {
                alert(data.message);
                // ì„ íƒëœ íƒœê·¸ ìœ„ì¹˜ë¡œ AGV ì• ë‹ˆë©”ì´ì…˜ ì´ë™
                const tagPos = tag_nums[tagId];
                if (tagPos) {
                    animateAgvToTag(tagPos.x, tagPos.y);
                }
            });
        });

        // AGVë¥¼ ì§€ì • ìœ„ì¹˜ê¹Œì§€ ë¶€ë“œëŸ½ê²Œ ì´ë™ì‹œí‚¤ëŠ” í•¨ìˆ˜
        function animateAgvToTag(targetX, targetY) {
            const agvImage = document.getElementById('agv');
            let startX = parseFloat(agvImage.style.left);
            let startY = parseFloat(agvImage.style.top);
            let step = 0;
            const steps = 40;
            const deltaX = (targetX - startX) / steps;
            const deltaY = (targetY - startY) / steps;
            function moveStep() {
                if (step < steps) {
                    startX += deltaX;
                    startY += deltaY;
                    agvImage.style.left = startX + 'px';
                    agvImage.style.top = startY + 'px';
                    step++;
                    requestAnimationFrame(moveStep);
                } else {
                    agvImage.style.left = targetX + 'px';
                    agvImage.style.top = targetY + 'px';
                }
            }
            moveStep();
        }
        
                // ìƒíƒœ ì„ íƒ ì‹œ ì„œë²„ì— ì „ì†¡
                document.getElementById('stateSelect').addEventListener('change', function() {
                    const state = this.value;
                    fetch('/set_state', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ state: state })
                    }).then(res => res.json()).then(data => {
                        alert(data.message);
                    });
                });
        
                // GO ë²„íŠ¼ í´ë¦­ ì‹œ Running ìƒíƒœë¡œ ë³€ê²½
                document.getElementById('goBtn').addEventListener('click', function() {
                    fetch('/set_state', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ state: 'Running' })
                    }).then(res => res.json()).then(data => {
                        alert(data.message);
                    });
                });
        let agvAnimPosition = { x: 1491, y: 640 };  // ì• ë‹ˆë©”ì´ì…˜ ìœ„ì¹˜
        let agvAnimAngle = 0;                       // ì• ë‹ˆë©”ì´ì…˜ ê°ë„ (ìœ„ìª½ ì •ë°©í–¥ = 0ë„)
        let pathProgress = 0;                       // ê²½ë¡œ ì§„í–‰ë¥  (0~1)
        let currentSegmentIndex = 0;                // í˜„ì¬ ì„¸ê·¸ë¨¼íŠ¸ ì¸ë±ìŠ¤
        let isAnimating = false;                    // ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰ ì—¬ë¶€ (Ready ìƒíƒœì—ì„œ ì‹œì‘)
        let waitingForTag = false;                  // íƒœê·¸ ëŒ€ê¸° ì¤‘
        let nextExpectedTagId = null;               // ë‹¤ìŒ ì˜ˆìƒ íƒœê·¸ ID
        let lastDetectedTagId = null;               // ë§ˆì§€ë§‰ ê°ì§€ëœ íƒœê·¸ ID (ì• ë‹ˆë©”ì´ì…˜ ê¸°ì¤€)
        let lastSensorTagId = null;                 // ë§ˆì§€ë§‰ ì„¼ì„œ íƒœê·¸ ID (ì‹¤ì œ AGV)
        let agvTrajectory = [];                     // AGV ê¶¤ì  ì €ì¥
        let currentSpeedLimit = 200;                // í˜„ì¬ ì†ë„ ì œí•œê°’ (mm/s)
        let tag_nums = {};                          // íƒœê·¸ ìœ„ì¹˜ ì •ë³´ (id: {x, y, speed_limit})

        // ê²½ë¡œ ë°ì´í„° (ì„œë²„ì—ì„œ ì œê³µí•˜ì§€ë§Œ ì• ë‹ˆë©”ì´ì…˜ìš©ìœ¼ë¡œ ë³µì‚¬)
        const driving_path = {{ driving_path | tojson | safe }};
        
        // driving_pathê°€ ì—†ìœ¼ë©´ ì—ëŸ¬ ì¶œë ¥
        if (!driving_path || driving_path.length === 0) {
            console.error('âŒ driving_pathê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!');
        } else {
            console.log('âœ… driving_path ë¡œë“œ ì™„ë£Œ:', driving_path.length, 'ê°œ ì„¸ê·¸ë¨¼íŠ¸');
        }

        // Function to send command without reloading the page
        function sendCommand(command) {
            fetch('/command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'command=' + command
            })
            .then(response => response.json())
            .then(data => {
                console.log('Command response:', data);
            })
            .catch(error => console.error('Error sending command:', error));
        }

        // GO ë²„íŠ¼ í•¸ë“¤ëŸ¬: ì‹œì‘í•˜ë©´ì„œ Pause ë²„íŠ¼ì„ "Pause"ë¡œ ë¦¬ì…‹
        function handleGo() {
            sendCommand('go');
            const pauseBtn = document.getElementById('pauseBtn');
            pauseBtn.textContent = 'Pause';
            
            // ì´ˆê¸° ìƒíƒœ: ì„¼ì„œ íƒœê·¸ 0, ì„œë²„ AGVëŠ” ëŒ€ê¸°
            isAnimating = false;
            waitingForTag = false;
            console.log('ğŸš€ GO ë²„íŠ¼: ì´ˆê¸°í™” ì™„ë£Œ - ì„¼ì„œ Tag 1 ê°ì§€ê¹Œì§€ ëŒ€ê¸°');
        }

        // Pause/Resume í† ê¸€: ë²„íŠ¼ í…ìŠ¤íŠ¸ì— ë”°ë¼ ëª…ë ¹ ì „ì†¡ ë° í…ìŠ¤íŠ¸ í† ê¸€
        function handlePauseResume() {
            const pauseBtn = document.getElementById('pauseBtn');
            if (pauseBtn.textContent === 'Pause') {
                sendCommand('pause');
                pauseBtn.textContent = 'Resume';
            } else {
                sendCommand('resume');
                pauseBtn.textContent = 'Pause';
            }
        }

        // ë¹„ìƒì •ì§€ ë²„íŠ¼: E-stop ëª…ë ¹ ì „ì†¡
        function handleEmergency() {
            sendCommand('E-stop');
            const pauseBtn = document.getElementById('pauseBtn');
            pauseBtn.textContent = 'Resume';
        }

        // Tag Numbers(2~9) ì´ˆê¸°í™”: ì„œë²„ê°€ ê²½ë¡œ ë²•ì„  ê¸°ì¤€ìœ¼ë¡œ ì˜¤í”„ì…‹ëœ ì¢Œí‘œë¥¼ ë°˜í™˜í•¨
        function initializeTagNums() {
            fetch('/tag_nums')
                .then(response => response.json())
                .then(tags => {
                    tag_nums = tags;  // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
                    console.log('âœ… Tag ìœ„ì¹˜ ì •ë³´ ë¡œë“œ:', Object.keys(tag_nums).length, 'ê°œ');
                    console.log('ğŸ“ Tag ìœ„ì¹˜:', tag_nums);
                    const container = document.getElementById('tag-num-container');
                    container.innerHTML = '';
                    Object.entries(tags).forEach(([id, info]) => {
                        const square = document.createElement('div');
                        square.className = 'tag-num';
                        // ì„œë²„ì—ì„œ ì´ë¯¸ ì˜¤í”„ì…‹ëœ ì¢Œí‘œë¥¼ ì œê³µ
                        const x = info.x;
                        const y = info.y;
                        square.style.left = (x - 11) + 'px'; // 22px -> center
                        square.style.top  = (y - 11) + 'px';
                        square.textContent = id;

                        container.appendChild(square);
                    });
                })
                .catch(err => console.error('Error loading tag nums:', err));
        }

        // ë§ˆì§€ë§‰ìœ¼ë¡œ í™”ë©´ì— ë Œë”í•œ íšŒì „ê°’(ì—°ì†ê°, ì–¸ë©ë“œ)
        let lastRenderedRotation = null;

        // Function to update AGV position and data on the page
        function updateAgvData() {
            fetch('/data')
                .then(response => response.json())
                .then(data => {
                    const agvImage = document.getElementById('agv');
                    const trajectorySvg = document.getElementById('trajectory-svg');

                    // ===== 0. ìƒíƒœ íŒ¨ë„ ì—…ë°ì´íŠ¸ =====
                    document.getElementById('agv-status').textContent = data.agv_status || 'IDLE';
                    document.getElementById('current-tag').textContent = data.current_tag || '-';
                    document.getElementById('battery-level').textContent = data.battery + '%' || '100%';
                    const speedLimit = data.rf_tag?.speed_limit || 200;
                    document.getElementById('speed-limit').textContent = speedLimit + ' mm/s';
                    document.getElementById('lidar-distance').textContent = (data.lidar_distance !== undefined ? data.lidar_distance + ' mm' : '- mm');
                    document.getElementById('current-speed').textContent = (data.current_speed || 0) + ' mm/s';
                    currentSpeedLimit = speedLimit;

                    // ===== 1. ì„¼ì„œ íƒœê·¸ ë™ê¸°í™” (ì í”„/ëŒ€ê¸° í•´ì œ) =====
                    if (data.current_tag && data.current_tag !== '-') {
                        const sensorTagId = parseInt(data.current_tag);
                        
                        if (sensorTagId !== lastSensorTagId) {
                            const currentServerTag = lastDetectedTagId || 0;
                            console.log(`ğŸ“¡ ì„¼ì„œ: ${lastSensorTagId || 0} â†’ ${sensorTagId}, ì„œë²„: ${currentServerTag}`);
                            lastSensorTagId = sensorTagId;
                            
                            if (sensorTagId > currentServerTag) {
                                // ì„¼ì„œê°€ ì•ì„œê° â†’ ì„œë²„ AGV ì í”„
                                const tagPos = tag_nums[sensorTagId.toString()];
                                if (tagPos) {
                                    resetAGVToTagPosition(sensorTagId, tagPos.x, tagPos.y);
                                    waitingForTag = false;
                                    isAnimating = true;
                                    console.log(`âš¡ ì í”„: Tag ${sensorTagId} (${tagPos.x}, ${tagPos.y})`);
                                } else {
                                    console.warn(`âš ï¸ Tag ${sensorTagId} ìœ„ì¹˜ ì—†ìŒ`);
                                }
                            }
                            else if (sensorTagId === currentServerTag && waitingForTag) {
                                // ì„¼ì„œê°€ ì„œë²„ë¥¼ ë”°ë¼ì¡ìŒ â†’ ëŒ€ê¸° í•´ì œ
                                waitingForTag = false;
                                isAnimating = true;
                                console.log(`âœ… ëŒ€ê¸° í•´ì œ: Tag ${sensorTagId}`);
                            }
                        }
                    }
                    
                    // ===== 2. ë¼ì¸ íŠ¸ë ˆì´ì‹± ìƒíƒœ í™•ì¸ =====
                    if (data.is_line_following === false) {
                        isAnimating = false;
                        console.log('â¸ï¸ ë¼ì¸ íŠ¸ë ˆì´ì‹± ì¤‘ë‹¨');
                    } else if (data.is_line_following === true && !waitingForTag) {
                        isAnimating = true;
                        console.log('â–¶ï¸ ë¼ì¸ íŠ¸ë ˆì´ì‹± ì¬ê°œ');
                    }
                    
                    // ===== 3. AGV ìƒíƒœ ë³€ê²½ ê°ì§€ =====
                    handleAGVStateChange(data.agv_status);
                    
                    // ===== 4. ì• ë‹ˆë©”ì´ì…˜ ì—…ë°ì´íŠ¸ =====
                    updateAGVAnimation();
                    
                    // ì• ë‹ˆë©”ì´ì…˜ ìœ„ì¹˜ë¡œ AGV ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
                    agvImage.style.left = agvAnimPosition.x + 'px';
                    agvImage.style.top = agvAnimPosition.y + 'px';
                    agvImage.style.transform = `translate(-50%, -50%) rotate(${agvAnimAngle}deg)`;

                    // ê¶¤ì  ì—…ë°ì´íŠ¸ (ì• ë‹ˆë©”ì´ì…˜ ìœ„ì¹˜ ê¸°ë°˜)
                    trajectorySvg.innerHTML = ''; // ê¸°ì¡´ ê¶¤ì  ì§€ìš°ê¸°
                    if (agvTrajectory.length > 0) {
                        agvTrajectory.forEach((point, index) => {
                            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                            circle.setAttribute('cx', point.x);
                            circle.setAttribute('cy', point.y);
                            circle.setAttribute('r', '2');
                            circle.setAttribute('fill', `hsl(${index * 0.5}, 70%, 50%)`);
                            trajectorySvg.appendChild(circle);
                        });
                    }

                    // E-Stop ìƒíƒœ ê°ì§€ ì‹œ ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ (í™•ì¸ ë²„íŠ¼ í¬í•¨)
                    if (data.agv_status === 'Push-EStop' || data.agv_status === 'SRV-EStop') {
                if (!document.getElementById('estop-warning')) {
                    const warningBox = document.createElement('div');
                    warningBox.id = 'estop-warning';
                    warningBox.style.position = 'fixed';
                    warningBox.style.top = '50%';
                    warningBox.style.left = '50%';
                    warningBox.style.transform = 'translate(-50%, -50%)';
                    warningBox.style.background = 'rgba(234, 88, 12, 0.95)';
                    warningBox.style.color = 'white';
                    warningBox.style.padding = '30px 50px';
                    warningBox.style.borderRadius = '12px';
                    warningBox.style.fontSize = '24px';
                    warningBox.style.fontWeight = 'bold';
                    warningBox.style.textAlign = 'center';
                    warningBox.style.zIndex = '10000';
                    warningBox.style.boxShadow = '0 8px 32px rgba(0,0,0,0.5)';
                    
                    const estopType = data.agv_status === 'Push-EStop' ? 'ë¹„ìƒì •ì§€ ë²„íŠ¼' : 'ì„œë²„ ë¹„ìƒì •ì§€';
                    const estopIcon = data.agv_status === 'Push-EStop' ? 'ğŸ”´' : 'ğŸš¨';
                    
                    warningBox.innerHTML = `
                        ${estopIcon} ${estopType} ë°œìƒ ${estopIcon}<br>
                        <div style="font-size: 18px; margin-top: 15px; font-weight: normal;">
                            ${data.agv_status === 'Push-EStop' ? 
                              'AGVì˜ ë¬¼ë¦¬ì  ë¹„ìƒì •ì§€ ë²„íŠ¼ì´ ëˆŒë ¸ìŠµë‹ˆë‹¤.' : 
                              'ì„œë²„ì—ì„œ ë¹„ìƒì •ì§€ ëª…ë ¹ì´ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.'}<br>
                            ìƒí™©ì„ í™•ì¸í•œ í›„ ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
                        </div>
                        <button id="acknowledge-btn" style="
                            margin-top: 20px;
                            padding: 12px 30px;
                            font-size: 18px;
                            font-weight: bold;
                            background: white;
                            color: #ea580c;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        ">í™•ì¸ ë° ì‹œìŠ¤í…œ ì¢…ë£Œ</button>
                    `;
                    document.body.appendChild(warningBox);
                    
                    // í™•ì¸ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
                    document.getElementById('acknowledge-btn').addEventListener('click', function() {
                        fetch('/acknowledge_estop', { method: 'POST' })
                            .then(response => response.json())
                            .then(result => {
                                console.log('E-Stop acknowledged:', result);
                                // ê²½ê³ ì°½ ì œê±° (Abnormal ê²½ê³ ì°½ì´ ëŒ€ì‹  í‘œì‹œë¨)
                                warningBox.remove();
                            })
                            .catch(error => console.error('Acknowledge failed:', error));
                    });
                }
            } else {
                // E-Stop ìƒíƒœ ì•„ë‹ ë•Œ ê²½ê³  ë©”ì‹œì§€ ì œê±°
                const estopWarning = document.getElementById('estop-warning');
                if (estopWarning) {
                    estopWarning.remove();
                }
            }
            
            // OBS-EStop ìƒíƒœ ê°ì§€ ì‹œ ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ (ìë™ ë³µêµ¬)
            if (data.agv_status === 'OBS-EStop') {
                if (!document.getElementById('obs-estop-warning')) {
                    const warningBox = document.createElement('div');
                    warningBox.id = 'obs-estop-warning';
                    warningBox.style.position = 'fixed';
                    warningBox.style.top = '50%';
                    warningBox.style.left = '50%';
                    warningBox.style.transform = 'translate(-50%, -50%)';
                    warningBox.style.background = 'rgba(234, 88, 12, 0.95)';
                    warningBox.style.color = 'white';
                    warningBox.style.padding = '30px 50px';
                    warningBox.style.borderRadius = '12px';
                    warningBox.style.fontSize = '24px';
                    warningBox.style.fontWeight = 'bold';
                    warningBox.style.textAlign = 'center';
                    warningBox.style.zIndex = '10000';
                    warningBox.style.boxShadow = '0 8px 32px rgba(0,0,0,0.5)';
                    
                    warningBox.innerHTML = `
                        ğŸš§ ì¥ì• ë¬¼ ê°ì§€! ğŸš§<br>
                        <div style="font-size: 18px; margin-top: 15px; font-weight: normal;">
                            ì¥ì• ë¬¼ê³¼ ì¶©ëŒí•©ë‹ˆë‹¤.<br>
                            ì•ˆì „ì„ ìœ„í•´ ê¸´ê¸‰ì •ì§€ í•©ë‹ˆë‹¤.<br>
                            <span style="color: #fde047; margin-top: 10px; display: block;">
                                ì¥ì• ë¬¼ì„ ì œê±°í•˜ë©´ ìë™ìœ¼ë¡œ ì¬ê°œë©ë‹ˆë‹¤.
                            </span>
                        </div>
                    `;
                    document.body.appendChild(warningBox);
                }
            } else {
                // OBS-EStop ìƒíƒœ ì•„ë‹ ë•Œ ê²½ê³  ë©”ì‹œì§€ ìë™ ì œê±°
                const obsWarning = document.getElementById('obs-estop-warning');
                if (obsWarning) {
                    obsWarning.remove();
                }
            }
            
            // ë¹„ì •ìƒ ìƒíƒœ ê°ì§€ ì‹œ ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ
            if (data.agv_status === 'Abnormal') {
                if (!document.getElementById('abnormal-warning')) {
                    const warningBox = document.createElement('div');
                    warningBox.id = 'abnormal-warning';
                    warningBox.style.position = 'fixed';
                    warningBox.style.top = '50%';
                    warningBox.style.left = '50%';
                    warningBox.style.transform = 'translate(-50%, -50%)';
                    warningBox.style.background = 'rgba(220, 38, 38, 0.95)';
                    warningBox.style.color = 'white';
                    warningBox.style.padding = '30px 50px';
                    warningBox.style.borderRadius = '12px';
                    warningBox.style.fontSize = '24px';
                    warningBox.style.fontWeight = 'bold';
                    warningBox.style.textAlign = 'center';
                    warningBox.style.zIndex = '10000';
                    warningBox.style.boxShadow = '0 8px 32px rgba(0,0,0,0.5)';
                    warningBox.innerHTML = `
                        âš ï¸ ë¹„ì •ìƒ ìƒíƒœì…ë‹ˆë‹¤ âš ï¸<br>
                        <div style="font-size: 18px; margin-top: 15px; font-weight: normal;">
                            ì‹œìŠ¤í…œì— ì¹˜ëª…ì  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>
                            í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•˜ê³  ì¬ì‹œì‘í•´ì£¼ì„¸ìš”.
                        </div>
                    `;
                    document.body.appendChild(warningBox);
                }
            } else {
                // ë¹„ì •ìƒ ìƒíƒœ ì•„ë‹ ë•Œ ê²½ê³  ë©”ì‹œì§€ ì œê±°
                const warningBox = document.getElementById('abnormal-warning');
                if (warningBox) {
                    warningBox.remove();
                }
            }

                })
                .catch(error => console.error('Error fetching AGV data:', error));
        }

        // ========================================
        // AGV ì• ë‹ˆë©”ì´ì…˜ í•¨ìˆ˜ë“¤
        // ========================================

        // SVG path íŒŒì‹± í•¨ìˆ˜
        function parseSVGPath(d) {
            const nums = d.match(/[-+]?[0-9]*\.?[0-9]+/g).map(Number);
            return {
                start: [nums[0], nums[1]],
                control: [nums[2], nums[3]],
                end: [nums[4], nums[5]]
            };
        }

        // ê²½ë¡œ ìƒì˜ ìœ„ì¹˜ ê³„ì‚°
        function getPositionOnPath(segmentIndex, t) {
            if (segmentIndex >= driving_path.length) {
                return null;
            }
            
            const segment = driving_path[segmentIndex];
            
            if (segment.type === 'line') {
                const x = segment.x1 + (segment.x2 - segment.x1) * t;
                const y = segment.y1 + (segment.y2 - segment.y1) * t;
                const angle = Math.atan2(segment.y2 - segment.y1, segment.x2 - segment.x1);
                return { x, y, angle: angle * (180 / Math.PI) + 90 }; // ë¼ë””ì•ˆ â†’ ë„, AGV.png ë³´ì • (+90ë„)
            } else if (segment.type === 'curve') {
                const parsed = parseSVGPath(segment.d);
                const x0 = parsed.start[0];
                const y0 = parsed.start[1];
                const cx = parsed.control[0];
                const cy = parsed.control[1];
                const x1 = parsed.end[0];
                const y1 = parsed.end[1];
                
                // Quadratic Bezier ê³µì‹
                const mt = 1 - t;
                const x = mt * mt * x0 + 2 * mt * t * cx + t * t * x1;
                const y = mt * mt * y0 + 2 * mt * t * cy + t * t * y1;
                
                // ì ‘ì„  ë°©í–¥ ê³„ì‚°
                const dx = 2 * mt * (cx - x0) + 2 * t * (x1 - cx);
                const dy = 2 * mt * (cy - y0) + 2 * t * (y1 - cy);
                const angle = Math.atan2(dy, dx);
                
                return { x, y, angle: angle * (180 / Math.PI) + 90 }; // ë¼ë””ì•ˆ â†’ ë„, AGV.png ë³´ì • (+90ë„)
            }
            
            return null;
        }

        // ì„¸ê·¸ë¨¼íŠ¸ ê¸¸ì´ ê³„ì‚°
        function getSegmentLength(segmentIndex) {
            const segment = driving_path[segmentIndex];
            
            if (segment.type === 'line') {
                const dx = segment.x2 - segment.x1;
                const dy = segment.y2 - segment.y1;
                return Math.sqrt(dx * dx + dy * dy);
            } else if (segment.type === 'curve') {
                // ê³¡ì„  ê·¼ì‚¬ ê¸¸ì´ (ìƒ˜í”Œë§)
                let length = 0;
                const steps = 50;
                let prevPos = getPositionOnPath(segmentIndex, 0);
                
                for (let i = 1; i <= steps; i++) {
                    const t = i / steps;
                    const pos = getPositionOnPath(segmentIndex, t);
                    const dx = pos.x - prevPos.x;
                    const dy = pos.y - prevPos.y;
                    length += Math.sqrt(dx * dx + dy * dy);
                    prevPos = pos;
                }
                
                return length;
            }
            
            return 0;
        }

        // ê±°ë¦¬ ê³„ì‚°
        function calculateDistance(pos1, pos2) {
            const dx = pos2.x - pos1.x;
            const dy = pos2.y - pos1.y;
            return Math.sqrt(dx * dx + dy * dy);
        }

        // ë‹¤ìŒ íƒœê·¸ ì°¾ê¸°
        function getNextExpectedTag() {
            // tag_num.jsonì—ì„œ ë¡œë“œëœ íƒœê·¸ ìˆœì„œëŒ€ë¡œ
            // ê°„ë‹¨í•˜ê²Œ lastDetectedTagId + 1
            if (lastDetectedTagId === null) {
                return 1; // ì²« íƒœê·¸
            }
            return (lastDetectedTagId % 10) + 1; // 1~10 ìˆœí™˜
        }

        // ë‹¤ìŒ íƒœê·¸ì™€ì˜ ê±°ë¦¬ í™•ì¸
        function checkArrivalAtNextTag() {
            if (!CONFIG.WAIT_AT_TAG) return;
            
            const nextTagId = getNextExpectedTag();
            
            // tag_num.jsonì—ì„œ íƒœê·¸ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸° (fetchë¡œ ê°€ì ¸ì™€ì•¼ í•˜ì§€ë§Œ ê°„ë‹¨í•˜ê²Œ)
            // ì—¬ê¸°ì„œëŠ” ì„ì‹œë¡œ ìŠ¤í‚µí•˜ê³ , ì„œë²„ì—ì„œ íƒœê·¸ ê°ì§€ ì‹œ ì²˜ë¦¬
        }

        // AGV ì• ë‹ˆë©”ì´ì…˜ ì—…ë°ì´íŠ¸
        function updateAGVAnimation() {
            if (!isAnimating || waitingForTag) return;
            
            // í˜„ì¬ ì„¸ê·¸ë¨¼íŠ¸ ê¸¸ì´
            const segmentLength = getSegmentLength(currentSegmentIndex);
            
            // í˜„ì¬ ì†ë„ì— ë¹„ë¡€í•œ ì• ë‹ˆë©”ì´ì…˜ ì†ë„ ê³„ì‚° (200mm/s ê¸°ì¤€ = 1.5 í”½ì…€/í”„ë ˆì„)
            const speedRatio = currentSpeedLimit / 200.0;  // ì˜ˆ: 100mm/s â†’ 0.5, 50mm/s â†’ 0.25
            const currentAnimSpeed = CONFIG.AGV_ANIMATION_SPEED_BASE * speedRatio;
            
            // ì§„í–‰ë¥  ì¦ê°€
            pathProgress += currentAnimSpeed / segmentLength;
            
            // ì„¸ê·¸ë¨¼íŠ¸ ì™„ë£Œ ì‹œ ë‹¤ìŒ ì„¸ê·¸ë¨¼íŠ¸ë¡œ
            if (pathProgress >= 1.0) {
                pathProgress = 0;
                currentSegmentIndex++;
                
                // ëª¨ë“  ê²½ë¡œ ì™„ë£Œ ì‹œ ì²˜ìŒìœ¼ë¡œ
                if (currentSegmentIndex >= driving_path.length) {
                    currentSegmentIndex = 0;
                    agvTrajectory = []; // ê¶¤ì  ì´ˆê¸°í™”
                }
                
                // â˜… í•µì‹¬: ì„œë²„ AGVê°€ ë‹¤ìŒ íƒœê·¸ì— ë„ì°©í–ˆëŠ”ì§€ í™•ì¸
                const nextServerTag = (lastDetectedTagId || 0) + 1;
                const currentSensorTag = lastSensorTagId || 0;
                
                // í˜„ì¬ ì„¸ê·¸ë¨¼íŠ¸ì— í•´ë‹¹í•˜ëŠ” íƒœê·¸ê°€ ìˆëŠ”ì§€ í™•ì¸
                const segmentInfo = driving_path[currentSegmentIndex];
                if (segmentInfo && segmentInfo.tag_id === nextServerTag) {
                    lastDetectedTagId = nextServerTag;
                    console.log(`ğŸš© ì„œë²„ AGVê°€ Tag ${nextServerTag}ì— ë„ì°©`);
                    
                    // ì„¼ì„œ íƒœê·¸ê°€ ì•„ì§ ë„ì°© ì•ˆ í–ˆìœ¼ë©´ ëŒ€ê¸°
                    if (currentSensorTag < nextServerTag) {
                        waitingForTag = true;
                        isAnimating = false;
                        console.log(`â³ ëŒ€ê¸° ì‹œì‘: ì„œë²„ Tag ${nextServerTag} ë„ì°©, ì„¼ì„œëŠ” Tag ${currentSensorTag} â†’ ëŒ€ê¸°`);
                    }
                }
            }
            
            // í˜„ì¬ ìœ„ì¹˜ ê³„ì‚°
            const pos = getPositionOnPath(currentSegmentIndex, pathProgress);
            if (pos) {
                agvAnimPosition.x = pos.x;
                agvAnimPosition.y = pos.y;
                
                // ê°ë„ ìµœë‹¨ ê²½ë¡œë¡œ ì—…ë°ì´íŠ¸ (270ë„ íšŒì „ ë°©ì§€)
                let targetAngle = pos.angle;
                let angleDiff = targetAngle - agvAnimAngle;
                
                // -180 ~ 180 ë²”ìœ„ë¡œ ì •ê·œí™”
                while (angleDiff > 180) angleDiff -= 360;
                while (angleDiff < -180) angleDiff += 360;
                
                agvAnimAngle += angleDiff;
                
                // ê¶¤ì  ì¶”ê°€ (ì¼ì • ê±°ë¦¬ë§ˆë‹¤)
                if (agvTrajectory.length === 0 || 
                    calculateDistance(agvAnimPosition, agvTrajectory[agvTrajectory.length - 1]) > 10) {
                    agvTrajectory.push({ x: pos.x, y: pos.y });
                    
                    // ê¶¤ì ì´ ë„ˆë¬´ ê¸¸ì–´ì§€ë©´ ì˜¤ë˜ëœ ê²ƒ ì œê±°
                    if (agvTrajectory.length > 500) {
                        agvTrajectory.shift();
                    }
                }
            }
        }

        // íƒœê·¸ ê°ì§€ ì‹œ AGV ìœ„ì¹˜ ë¦¬ì…‹
        function resetAGVToTagPosition(tagId, tagX, tagY) {
            console.log(`ğŸ”§ resetAGVToTagPosition í˜¸ì¶œ: Tag ${tagId}, í˜„ì¬ ì„œë²„ AGV: ${lastDetectedTagId || 0}`);
            
            agvAnimPosition.x = tagX;
            agvAnimPosition.y = tagY;
            
            // í•´ë‹¹ íƒœê·¸ ìœ„ì¹˜ì— ê°€ì¥ ê°€ê¹Œìš´ ì„¸ê·¸ë¨¼íŠ¸ ì°¾ê¸°
            let minDist = Infinity;
            let closestSegmentIndex = currentSegmentIndex;
            
            for (let i = 0; i < driving_path.length; i++) {
                const segment = driving_path[i];
                const dist = calculateDistance({x: tagX, y: tagY}, {x: segment.x, y: segment.y});
                if (dist < minDist) {
                    minDist = dist;
                    closestSegmentIndex = i;
                }
            }
            
            // ì„¸ê·¸ë¨¼íŠ¸ ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸ (ì í”„)
            currentSegmentIndex = closestSegmentIndex;
            pathProgress = 0;
            console.log(`ğŸ¯ ì„¸ê·¸ë¨¼íŠ¸ ${closestSegmentIndex}ë¡œ ì í”„ (Tag ${tagId})`);
            
            // â˜… ì¤‘ìš”: lastDetectedTagIdë¥¼ ë§ˆì§€ë§‰ì— ì—…ë°ì´íŠ¸
            lastDetectedTagId = tagId;
        }

        // AGV ìƒíƒœ ë³€ê²½ ì²˜ë¦¬
        function handleAGVStateChange(state) {
            const stateUpper = (state || '').toUpperCase();
            
            if (stateUpper === 'RUNNING' || stateUpper === 'RESUME') {
                // RUNNING ìƒíƒœë¼ë„ ëŒ€ê¸° ì¤‘ì´ë©´ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘ ì•ˆ í•¨
                if (!waitingForTag) {
                    isAnimating = true;
                }
                console.log(`â–¶ï¸ AGV RUNNING (ëŒ€ê¸° ì¤‘: ${waitingForTag})`);
            } else if (stateUpper === 'PAUSED') {
                isAnimating = false;
                console.log('â¸ï¸ AGV ì¼ì‹œì •ì§€');
            } else if (stateUpper.includes('ESTOP') || stateUpper === 'PUSH-ESTOP' || stateUpper === 'OBS-ESTOP' || stateUpper === 'SRV-ESTOP') {
                isAnimating = false;
                console.log('ğŸš¨ AGV ë¹„ìƒì •ì§€');
            } else if (stateUpper === 'READY' || stateUpper === 'INITIAL') {
                isAnimating = false;
                // Tag 10 ì´í›„ì—ëŠ” ì´ˆê¸°í™”í•˜ì§€ ì•ŠìŒ
                if (lastDetectedTagId < 10) {
                    // ì´ˆê¸° ìœ„ì¹˜ë¡œ ë¦¬ì…‹
                    agvAnimPosition = { x: 1491, y: 620 };
                    agvAnimAngle = 0;
                    currentSegmentIndex = 0;
                    pathProgress = 0;
                    agvTrajectory = []; // ê¶¤ì  ì´ˆê¸°í™”
                    console.log('â¹ï¸ AGV ëŒ€ê¸° ì¤‘ (Ready)');
                } else {
                    console.log('ğŸ Tag 10 ì™„ë£Œ - ìœ„ì¹˜ ìœ ì§€');
                }
            }
        }

        // ========================================
        // ê¸°ì¡´ updateAgvData ìˆ˜ì • í•„ìš”
        // ========================================

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.onload = function() {
            // localhost ì ‘ì† ì‹œ ìë™ ë¦¬ë‹¤ì´ë ‰íŠ¸ ëŒ€ì‹  ì•ˆë‚´ ë°°ë„ˆë§Œ í‘œì‹œ
            const lanHost = "{{ lan_ip }}";
            const host = window.location.hostname;
            if ((host === '127.0.0.1' || host === 'localhost') && lanHost && lanHost !== '127.0.0.1') {
                const banner = document.createElement('div');
                banner.style.position = 'fixed';
                banner.style.top = '10px';
                banner.style.right = '10px';
                banner.style.background = 'rgba(0,0,0,0.7)';
                banner.style.color = '#fff';
                banner.style.padding = '8px 12px';
                banner.style.borderRadius = '6px';
                banner.style.fontSize = '12px';
                banner.style.zIndex = '9999';
                banner.innerHTML = `LAN ì ‘ì†: <a href="http://${lanHost}:5000" style="color:#4fc3f7; text-decoration:underline;">http://${lanHost}:5000</a>`;
                document.body.appendChild(banner);
            }
            initializeTagNums();
            
            // AGV ì• ë‹ˆë©”ì´ì…˜ ì´ˆê¸°í™” (ëŒ€ê¸° ìƒíƒœ)
            isAnimating = false;
            console.log('â¹ï¸ AGV ëŒ€ê¸° ì¤‘ (Ready ìƒíƒœì—ì„œ Go ë²„íŠ¼ ëŒ€ê¸°)');
        };

        setInterval(updateAgvData, 100); // 0.1ì´ˆ(10Hz)ë¡œ ë³µì›í•©ë‹ˆë‹¤.
    </script>
</body>
</html>
```